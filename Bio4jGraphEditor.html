<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>
  Bio4j Graph Editor
</title>
<!-- Bootstrap Core CSS -->
<link href="css/bootstrap.css" rel="stylesheet" type='text/css'>
<link href="css/jquery-ui.css" rel="stylesheet" type='text/css'>
<link type="text/css" href="css/alpaca.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/joint.css" />
<link rel="stylesheet" href="css/font-awesome.min.css">
<style type="text/css">

  #wrapper {
      width: 100%;
      height: 100%;
      margin-left: 10px;
      margin-right: 10px;
  }

  #page-wrapper {
      background-color: #fff;
      height: 100%;
      width: 100%;
      margin-left: 10px;
      margin-right: 10px;
  }

  .nav-bar-logo{
  	margin-left: 30px;
  	height: 40px;
  }

  footer {
      background: #d9edf7;
      padding: 5px 0 5px 0px;
      border-top: 1px solid #4C8DAD;
  }

  .btn-file {
    position: relative;
    overflow: hidden;
  }
  .btn-file input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      background: white;
      cursor: inherit;
      display: block;
  }

  #node_types_list{
    background-color: #F0F0F0;
  }

  #graph-container{
    overflow: auto;
    max-height: 450px;
    min-height: 450px;
    border: 1px solid gray;
    background-color: #dbdbdb;
  }
  #node_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
  }
  #link_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
    min-height: 200px;
  }
  #backgrounds_list{
    overflow-y: auto;
    overflow-x: auto;
    max-height: 450px;
  }

  #inputNodeName{
    resize: none;
    width: 100%;
  }

  #nav_bar{
    width: 100%;
  }

</style>
<script type="text/javascript" src="js/joint.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui.js"></script>
<script type="text/javascript" src="js/d3.min.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script type="text/javascript" src="js/handlebars-v3.0.3.js"></script>
<script type="text/javascript" src="js/alpaca.min.js"></script>
<script type="text/javascript"> if (!window.console) console = {log: function() {}}; </script>
<script type="text/javascript"> window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;</script>
<body onload="onBodyLoad()">
  <div id="wrapper">
    <!-- Navigation -->
    <nav id="nav_bar" class="navbar navbar-default navbar-static-top navbar-transparent" role="navigation"  >
      <div class="navbar-header">
		      <a href="index.html" target="_blank" class="pull-left nav-bar-logo"><img src="images/biographika_logo_tiny.svg"></a>
          <!--<a class="navbar-brand"><strong>Biographika: </strong>Bio4j data graph visualization</a>-->
          <div class="nav navbar-nav btn-group">
            <ul class="nav navbar-nav">
              <li>
                <div class="dropdown">
                  <button type="button" data-toggle="dropdown" class="btn btn-default dropdown-toggle">Themes <span class="caret"></span></button>
                  <ul id="themesDropDownMenu" class="dropdown-menu">
                    <li class="dropdown-header">BIOLOGY</li>
                    <li><a id="proteinsThemeButton" role="button">Proteins</a></li>
                    <li class="dropdown-header">GENERAL</li>
                    <li><a id="basicThemeButton" role="button">Basic elements</a></li>
                    <li><a id="doPlanningThemeButton" role="button">Doplanning</a></li>
                  </ul>
                </div>
              </li>
              <li>
                <div>
                  <span class="btn btn-default btn-file" title="Load diagram file">
                      <i class="fa fa-file-code-o"></i>
                      <!--Load file...-->
                      <input type="file" accept=".json" >
                  </span>
                </div>
              </li>
              <li>
                <div class="dropdown">
                  <button type="button" class="btn btn-default" data-toggle="dropdown" title="Export diagram to...">
                    <i class="fa fa-download"></i>
                    <!--Export to...-->
                    <span class="caret"></span>
                  </button>
                  <ul id="exportDropDownMenu" class="dropdown-menu" >
                    <li><a id="exportToJSONButton" role="button" data-toggle="modal" >JSON</a></li>
                  </ul>
                </div>
              </li>
              <li>
                <button id="zoomInButton" title="Zoom in" onclick="zoomIn()" type="button" class="btn btn-default">
                  <i class="fa fa-search-plus"></i><!--Zoom in--></button>
              </li>
              <li>
                <button id="zoomOutButton" title="Zoom out" onclick="zoomOut()" type="button" class="btn btn-default">
                  <i class="fa fa-search-minus"></i><!--Zoom out--></button>
              </li>
              <li>
                <button id="resetZoomButton" title="Reset zoom" onclick="resetZoom()" type="button" class="btn btn-default">
                  <i class="fa fa-search"></i><!--Reset zoom--></button>
              </li>
              <li>
                <button id="rotateRightButton" title="Rotate node to the right" onclick="rotateCellToTheRight()" type="button" class="btn btn-default">
                  <i class="fa fa-undo"></i><!--Rotate to right-->
                </button>
              </li>
              <li>
                <button id="rotateLeftButton" title="Rotate node to the left" onclick="rotateCellToTheLeft()" type="button" class="btn btn-default">
                  <i class="fa fa-repeat"></i><!--Rotate to left--></button>
              </li>
              <li>
                <button id="bringToFrontButton" title="Bring node to front" onclick="bringSelectedCellToFront()" type="button" class="btn btn-default">
                  <i class="fa fa-clone"></i><i class="fa fa-arrow-right"></i><!--Bring to front--></button>
              </li>
              <li>
                <button id="bringToBackButton" title="Bring node to back" onclick="bringSelectedCellToBack()" type="button" class="btn btn-default">
                  <i class="fa fa-arrow-left"></i><i class="fa fa-clone"></i><!--Bring to back--></button>
              </li>
              <li>
                <button id="setBackgroundButton" title="Set background image" onclick="onSetBackgroundButtonClick()" type="button" class="btn btn-default">
                  <i class="fa fa-picture-o"></i><!--Set background--></button>
              </li>
              <li>
                <button id="showMetadataButton" title="Show node metadata" onclick="onShowMetadataButtonClick()" type="button" class="btn btn-default">
                  <i class="fa fa-newspaper-o"></i><!--Show metadata--></button>
              </li>
              <li>
                <button id="renameNodeButton" title="Rename node" onclick="onRenameNodeButtonClick()" type="button" class="btn btn-default">
                  <i class="fa fa-pencil-square-o"></i><!--Rename node--></button>
              </li>
              <li>
                <button id="fitPaperToContentsButton" title="Fit stage dimensions to contents" onclick="fitPaperToContents()" type="button" class="btn btn-default">
                  <i class="fa fa-arrows-alt"></i><!--Fit paper to contents--></button>
              </li>
              <li>
                <button id="selectNodeTypeButton" title="Select current node type" onclick="openDialogSelectNodeType()" type="button" class="btn btn-default">
                  <i id="currentNodeTypeIcon" class="fa fa-bullseye"></i>
                  <img id="currentNodeTypeImage">
                  </img>
                </button>
              </li>
              <li>
                <button id="selectLinkTypeButton" title="Select current link type" onclick="openDialogSelectLinkType()" type="button" class="btn btn-default">
                  <i class="fa fa-arrows-h"></i></button>
              </li>
              <li>
                <form class="navbar-form">
                  <div class="control-group">
                    <!--<span class="control-label">Stage dimensions</span>-->
                    <div class="controls form-inline">
                        <label for="inputWidth">Width</label>
                        <input onchange="updatePaperDimensionsBasedOnTextInputs()" value="200" type="number" class="input-small" placeholder="Width" id="inputWidth" min="200" max="2000">
                        <label for="inputHeight">Height</label>
                        <input onchange="updatePaperDimensionsBasedOnTextInputs()" value="100" type="number" class="input-small" placeholder="Height" id="inputHeight" min="100" max="1500">
                    </div>
                  </div>
                </form>
              </li>
              <li>
                <div class="checkbox">
                  <label><input id="lockDiagramCheckBox" type="checkbox" >Lock diagram</label>
                </div>
                <!-- lock diagram checkbox -->
              </li>
              <li>
                <div class="checkbox">
                  <label><input id="deleteNodeOnClickCheckBox" type="checkbox" >Delete node on click</label>
                </div>
                <!-- delete node on click checkbox -->
              </li>
              <li>
                <div id="currentNodeTypeDiv">
                </div>
              </li>
          </ul>
        </div>
    </nav>
    <div id="page-wrapper">
      <div id="diagram_row" class="row">
        <div id="graph-container" class="col-xs-12">
        </div>
      </div>
    </div>
    <!-- page-wrapper -->
  </div>
  <footer>
    <div class="container">
      <p>This example is part of <a href="http://www.biographika.com/" rel="author">Biographika</a> project.  100% of the code is open source and released under <a href="http://www.gnu.org/licenses/agpl-3.0.en.html" rel="external">AGPLv3</a> license.</p>
    </div>
  </footer>
  <div id="metadata_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Element Metadata</h4>
        </div>
        <div class="modal-body">
          <div id="metadata_form">
          </div>
        </div>
        <div class="modal-footer">
          <!--<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
          <button id="saveMetadataChangesButton" type="button" onclick="saveMetadataChanges()" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  <div id="background_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Background selector</h4>
        </div>
        <div class="modal-body">
          <div id="backgrounds_list">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="setSelectedBackground()" class="btn btn-primary">Set background</button>
        </div>
      </div>
    </div>
  </div>
  <div id="node_types_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Node type selector</h4>
        </div>
        <div class="modal-body">
          <div id="node_types_list">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="setSelectedNodeType()" class="btn btn-primary">Select node type</button>
        </div>
      </div>
    </div>
  </div>
  <div id="link_types_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Link type selector</h4>
        </div>
        <div class="modal-body">
          <div id="link_types_list">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="setSelectedLinkType()" class="btn btn-primary">Select link type</button>
        </div>
      </div>
    </div>
  </div>
  <div id="rename_node_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Rename node</h4>
        </div>
        <div class="modal-body">
          <label for="inputNodeName">New label</label>
          <br/>
          <textarea id="inputNodeName" ></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" onclick="applyRenameNode()" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">


 <!-- +++++++++++++++++++ MAIN VARS ++++++++++++++++++++++++ -->
 var graph, node_types_graph, link_types_graph, backgrounds_graph, paper,
    node_types_paper, link_types_paper, backgrounds_paper, protein_node_type,
    organism_node_type, genome_element_type, selected_node_type,
    current_node_type_graph, current_node_type_paper;

 //.......paper panning related vars........
 /**
 Flag indicating whether the paper is being currently panned
 */
 var paperIsPanning = false;
 var pointerDownClientX;
 var pointerDownClientY;
 var lastPositionMouseX;
 var lastPositionMouseY;
 /**
 Flag indicating whether the selected cell is currently being dragged
 */
 var nodeIsBeingDragged = false;
 //.........................................
 //.......paper zooming related vars........
 /**
 Initial scale for the paper
 */
 var initialPaperScale = 1;
 /**
 Represents the current scale of the paper
 */
 var paperScale = initialPaperScale;
 /**
 Factor used to either decrease or increase the scale of the paper
 */
 var paperScaleFactor = 0.2;
 /**
 Initial width for the paper
 */
 var paperInitialWidth = 500;
 /**
 Initial height for the paper
 */
 var paperInitialHeight = 200;
 //.........................................

 //-----node types cells------------------------
 /**
 Node type cell height used in the node type selector
 */
 var nodeTypeCellHeight = 100;
 /**
 Node type x position used in the node type selector
 */
 var nodeTypeCellDefaultX = 15;
 /**
 Node type maximum width allowed for nodes in the node type selector
 */
 var nodeTypeCellMaxWidth = 80;
 //----------------------------------------------

 //-----link types cells------------------------
 /**
 Link type cell height used in the link type selector
 */
 var linkTypeCellHeight = 60;
 /**
 Link type x position used in the link type selector
 */
 var linkTypeCellDefaultX = 15;
 /**
 Link type y position used in the link type selector
 */
 var linkTypeCellDefaultY = 30;
 /**
 Link type maximum width allowed for links in the node type selector
 */
 var linkTypeCellMaxWidth = 120;
 //----------------------------------------------

 //-----background cells------------------------
 /**
 Background height used for cells in the background type selector
 */
 var backgroundCellHeight = 250;
 /**
 Background x position used in the background type selector
 */
 var backgroundCellDefaultX = 15;
 /**
 Background maximum width allowed for background cells in the background type selector
 */
 var backgroundCellMaxWidth = 500;
 /**
 Width value for the paper of the background selector
 */
 var backgroundPaperWidth = 500;
 /**
 Height value for the paper of the background selector
 */
 var backgroundPaperHeight = 300;
 //----------------------------------------------

 /**
 Node type currently selected that will be used when creating new nodes
 */
 var selectedNodeTypeCell;
 /**
 Link type currently selected that will be used when creating new links
 */
 var selectedLinkTypeCell;
 /**
 Background type currently selected that will be used when setting a new background
 */
 var selectedBackgroundCell;
 /**
 Node currently selected
 */
 var selectedCell;
 /**
 Flag indicating whether the application is in read-only mode or not. Read-only
 mode means that neither of the following operations is allowed:
 - Create new nodes
 - Delete existing nodes
 - Create new links
 - Delete existing links
 - Move/modify nodes
 - Move/modify links
 - Update nodes metadata
 - Rename node labels
 */
 var readOnlyMode = false;
 /**
 Current background for the diagram (if any), null otherwise.
 */
 var currentBackgroundCell = null;
 /**
 Rect cell used to represent the selection of a node. It's always located behind
 the selected node. Its value is null in the case no node is currently selected.
 */
 var selectionRectCell = null;

 /**
 Flag used to identify the first time the background selector modal is shown
 */
 var backgroundsModalFirstTimeShown = true;
 var currentBackgroundThemeURL;

 /**
 Flag used to identify the first time the node type selector modal is shown
 */
 var nodeTypesModalFirstTimeShown = true;
 var currentNodeTypeThemeURL;

 /**
 Flag used to identify the first time the link type selector modal is shown
 */
 var linkTypesModalFirstTimeShown = true;
 var currentLinkTypeThemeURL;

 /**
 This variable holds the different type definitions (metadata properties for each node type)
 valid for the current theme.
 */
 var typeDefinitionsJSON;

 /**
 Factor used when rotating either to the left or to the right (number of degrees)
 */
 var rotateCellFactor = 10;

 /**
 This cell is used as a white background which is always behind all cells (nodes, bacground, links...)
 so that it can emulate the existence of the paper. That way the dimensions of the paper can be perceived
 by the contrast of this box with the greyish background.
 Events such as blank:pointerdown are no longer fired so they are emulated artificially
 when the user is clicking in the background box.
 */
 var backgroundBox;
 /**
 Control variable used to modify the alpaca form used to display/modify nodes metadata
 */
 var alpacaMetadataFormControl;

 //-----THEMES URLs------------------------
 var proteinsLinksThemeURL = "data/ProteinsLinksTheme.json";
 var proteinsElementsThemeURL = "data/ProteinsElementsTheme.json";
 var proteinsBackgroundThemeURL = "data/ProteinsBackgroundTheme.json";
 var proteinsTypesDefinitionURL = "data/ProteinsTypeDefinitions.json";
 var doPlanningLinksThemeURL = "data/DoPlanningLinksTheme.json";
 var doPlanningElementsThemeURL = "data/DoPlanningElementsTheme.json";
 var doPlanningBackgroundThemeURL = "data/ProteinsBackgroundTheme.json";
 var doPlanningTypesDefinitionURL = "data/ProteinsTypeDefinitions.json";
 var basicLinksThemeURL = "data/BasicLinksTheme.json";
 var basicElementsThemeURL = "data/BasicElementsTheme.json";
 var basicBackgroundThemeURL = "data/BasicBackgroundTheme.json";
 var basicTypesDefinitionURL = "data/BasicTypeDefinitions.json";
 var defaultLinksThemeURL = proteinsLinksThemeURL;
 var defaultElementsThemeURL = proteinsElementsThemeURL;
 var defaultBackgroundThemeURL = proteinsBackgroundThemeURL;
 var defaultTypesDefinitionURL = proteinsTypesDefinitionURL;
 //----------------------------------------------

 // Shortcuts.
 var rect = joint.shapes.basic.Rect;
 var path = joint.shapes.basic.Path;
 var circle = joint.shapes.basic.Circle;
 var ellipse = joint.shapes.basic.Ellipse;
 var polygon = joint.shapes.basic.Polygon;
 var polyline = joint.shapes.basic.Polyline;
 var text = joint.shapes.basic.Text;
 var link = joint.dia.Link;
 joint.shapes.basic.DecoratedRect = joint.shapes.basic.Generic.extend({

    markup: '<g class="rotatable"><g class="scalable"><rect/></g><image/><text/></g>',

    defaults: joint.util.deepSupplement({

        type: 'basic.DecoratedRect',
        size: { width: 100, height: 60 },
        attrs: {
            'rect': { fill: '#FFFFFF', stroke: 'black', width: 100, height: 60},
            'text': { 'font-size': 14, text: '', 'ref-x': .5, 'ref-y': .5, ref: 'rect', 'y-alignment': 'middle', 'x-alignment': 'middle', fill: 'black'  },

        }

    }, joint.shapes.basic.Generic.prototype.defaults)
  });
 var decoratedRect = joint.shapes.basic.DecoratedRect;




 //=================Config vars=======================
 /**
 Maximun number of characters that a node label can have in the same line
 */
 var nodeLabelMaxLength;
 //===================================================

 <!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


 <!--===================DOCUMENT EVENT HANDLERS======================== -->
 $(document).mousemove(function( event ) {

   if(paperIsPanning){

     var tempClientX = event.clientX;
     var tempClientY = event.clientY;
     var differenceX = tempClientX - lastPositionMouseX;
     var differenceY = tempClientY - lastPositionMouseY;
     var currentScrollLeft = $("#graph-container").scrollLeft();
     var currentScrollTop = $("#graph-container").scrollTop();

     lastPositionMouseX += differenceX;
     lastPositionMouseY += differenceY;

     $("#graph-container").scrollLeft(currentScrollLeft + differenceX);
     $("#graph-container").scrollTop(currentScrollTop + differenceY);

   }

   if(nodeIsBeingDragged){
      updateSelectionRectPosition();
   }

  });
 $(document).mouseup(function( event ) {
    //console.log("mouse up!");
    paperIsPanning = false;
    nodeIsBeingDragged = false;
 });

 <!--===================================================================-->

  <!-- LOAD GRAPH BUTTON... -->
  $(document).on('change', '.btn-file :file', function() {
      var input = $(this);
      var file = input.get(0).files[0];
      var fileNameSplit = file.name.split(".");
      var fileType = fileNameSplit[fileNameSplit.length - 1];

      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
  	      var contents = e.target.result;
          //console.log(fileType);
          if(fileType != "json"){
              alert("Please select a .json file");
          }else{
             graph.fromJSON(JSON.parse(contents));

             //var bbox = graph.getBBox(graph.getElements());
             var contentBBox = paper.getContentBBox();
             paperInitialWidth = contentBBox.width + contentBBox.x;
             paperInitialHeight = contentBBox.height + contentBBox.y;

             console.log("graph loaded!");

             updatePaperDimensionsTextInputs(paperInitialWidth, paperInitialHeight);

             deletePreviousBackgroundBox();
             initializeBackgroundBox(paperInitialWidth, paperInitialHeight);

             updatePaperDimensions(paperInitialWidth,paperInitialHeight);
             paper.render();
          }
        }
        reader.readAsText(file);
      } else {
        alert("Failed to load file");
      }
  });

  <!-- LOCK DIAGRAM CHECKBOX... -->
  $("#lockDiagramCheckBox").click( function(){

      var saveChangesMetadataButton = document.getElementById('saveMetadataChangesButton');

      if( $(this).is(':checked') ){
        readOnlyMode = true;
        if(alpacaMetadataFormControl){
          alpacaMetadataFormControl.enable();
        }
        if(saveChangesMetadataButton){
          saveChangesMetadataButton.style.visibility = 'hidden';
        }
      }else{
        readOnlyMode = false;
        if(alpacaMetadataFormControl){
          alpacaMetadataFormControl.disable();
        }
        if(saveChangesMetadataButton){
          saveChangesMetadataButton.style.visibility = 'visible';
        }
      }

      makeLinksInteractive(!readOnlyMode);
      makeElementsInteractive(!readOnlyMode);

      paper.render();
    }
  );


  <!-- EXPORT BUTTONS... -->
  $("#exportDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");
    if(buttonClicked == "exportToJSONButton"){
        exportToJSON();
    }

  });

  <!-- THEMES DROPDOWN... -->
  $("#themesDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");

    if(buttonClicked == "proteinsThemeButton"){

      //loadLinkTypesTheme(proteinsLinksThemeURL);
      //loadNodeTypesTheme(proteinsElementsThemeURL);
      //loadBackgroundsTheme(proteinsBackgroundThemeURL);
      loadTypeDefinitions(proteinsTypesDefinitionURL);

      currentBackgroundThemeURL = proteinsBackgroundThemeURL;
      currentNodeTypeThemeURL = proteinsElementsThemeURL;
      currentLinkTypeThemeURL = proteinsLinksThemeURL;

    }else if(buttonClicked == "doPlanningThemeButton"){

      //loadLinkTypesTheme(doPlanningLinksThemeURL);
      //loadNodeTypesTheme(doPlanningElementsThemeURL);
      //loadBackgroundsTheme(doPlanningBackgroundThemeURL);
      loadTypeDefinitions(doPlanningTypesDefinitionURL);

      currentBackgroundThemeURL = doPlanningBackgroundThemeURL;
      currentNodeTypeThemeURL = doPlanningElementsThemeURL;
      currentLinkTypeThemeURL = doPlanningLinksThemeURL;

    }else if(buttonClicked == "basicThemeButton"){

      //loadLinkTypesTheme(basicLinksThemeURL);
      //loadNodeTypesTheme(basicElementsThemeURL);
      //loadBackgroundsTheme(basicBackgroundThemeURL);
      loadTypeDefinitions(basicTypesDefinitionURL);

      currentBackgroundThemeURL = basicBackgroundThemeURL;
      currentNodeTypeThemeURL = basicElementsThemeURL;
      currentLinkTypeThemeURL = basicLinksThemeURL;
    }

  });

  <!-- MAKING NODE TYPES LIST ELEMENTS SELECTABLE -->
  $("ul li").click(function() {
    $(this).parent().children().removeClass("active");
    $(this).addClass("active");
  });

  <!-- BACKGROUNDS MODAL DIALOG -->
  $('#background_dialog').on('shown.bs.modal', function () {
    //console.log("backgrounds! shown.bs.modal");
    if(backgroundsModalFirstTimeShown){
      //console.log("backgroundsModalFirstTimeShown");
      initializeBackgroundsPaper(currentBackgroundThemeURL);
    }else{
      loadBackgroundsTheme(currentBackgroundThemeURL);
    }
    backgroundsModalFirstTimeShown = false;
  });

  <!-- NODE TYPES MODAL DIALOG -->
  $('#node_types_dialog').on('shown.bs.modal', function () {
    //console.log("node types! shown.bs.modal");
    if(nodeTypesModalFirstTimeShown){
      //console.log("nodeTypesModalFirstTimeShown");
      initializeNodeTypesPaper(currentNodeTypeThemeURL);
    }else{
      loadNodeTypesTheme(currentNodeTypeThemeURL);
    }
    nodeTypesModalFirstTimeShown = false;
  });

  <!-- LINK TYPES MODAL DIALOG -->
  $('#link_types_dialog').on('shown.bs.modal', function () {
    //console.log("link types! shown.bs.modal");
    if(linkTypesModalFirstTimeShown){
      //console.log("linkTypesModalFirstTimeShown");
      initializeLinkTypesPaper(currentLinkTypeThemeURL);
    }else{
      loadLinkTypesTheme(currentLinkTypeThemeURL);
    }
    linkTypesModalFirstTimeShown = false;
  });


  function initializeJoint(){
      //initializeCustomElements();
      initializeGraphPaper();
      //initializeNodeTypesPaper(defaultElementsThemeURL);
      //initializeLinkTypesPaper(defaultLinksThemeURL);
      //initializeBackgroundsPaper(defaultBackgroundThemeURL);
      loadTypeDefinitions(defaultTypesDefinitionURL);
  }

  /**
  Initializes the graph object plus the main paper where the diagram is displayed.
  Listeners for events fired by the paper are declared also here.
  */
  function initializeGraphPaper(){
    //console.log("initializeGraphPaper");

    graph = new joint.dia.Graph;

    paper = new joint.dia.Paper({
      el: $('#graph-container'),
      gridSize: 1,
      model: graph,
      width: paperInitialWidth,
      height: paperInitialHeight,
      defaultLink: getDefaultLink
    });

    //---update dimension values on text inputs
    $('#inputWidth').attr('value', paperInitialWidth);
    $('#inputHeight').attr('value', paperInitialHeight);

    paper.on("blank:pointerdown",
      function(evt, x, y){
          onStageDown(evt,x,y);
      }
    );

    paper.on("cell:mouseover",
      function(cellView, evt, x, y){
        if(cellView.model == backgroundBox){

        }
      }
    );
    paper.on("cell:mouseout",
      function(evt, x, y){
        //console.log("cell mouse out!");
      }
    );
    paper.on('cell:pointerdown',
      function(cellView, evt, x, y){
        if(cellView.model == backgroundBox || cellView.model == currentBackgroundCell){
          onStageDown(evt,x,y);
        }else{
          nodeIsBeingDragged = true;
        }
      }
    );
    paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {

        //console.log("cell:pointerclick!");

        if(cellView.model == backgroundBox){
          onBackgroundOrBackgroundBoxClick(evt,x,y);
        }else if(cellView.model == currentBackgroundCell){
          onBackgroundOrBackgroundBoxClick(evt,x,y);
        }else{

          if(document.getElementById("deleteNodeOnClickCheckBox").checked && !readOnlyMode){
            //console.log("remove!");
            cellView.remove();
            if(selectionRectCell){
              selectionRectCell.remove();
              selectionRectCell = null;
            }
          }

          if(selectedCell){
              if(cellView.id != selectedCell.id){
                selectNodeCell(selectedCell, false);
              }
          }
          selectNodeCell(cellView, true);

        }
      }
    );

    paper.on('cell:pointerup', function(cellView) {
        if (cellView.model instanceof joint.dia.Link){
          var tempLink = cellView.model;
          if(isLinkInvalid(tempLink)){
            tempLink.remove();
          }
        }
    });

    initializeBackgroundBox(paperInitialWidth, paperInitialHeight);

  }

  /**
  Initializes the white paper-sized rect cell that is permanently located behind
  all the rest of elements.
  */
  function initializeBackgroundBox(width, height){
    //console.log("initializeBackgroundBox");
    backgroundBox  = createBackgroundBox(0, 0, width, height, '#FFFFFF');
    backgroundBox.findView(paper).options.interactive = false;
    /**This is a flag used so that the background box cell can be identified for
    example when importing a diagram file    */
    backgroundBox.prop("background_box","true");
    backgroundBox.toBack();
  }
  /**
  Initializes the paper where link types are shown.
  This paper is used to select the current link type that will be used when creating
  new links on the diagram.
  */
  function initializeLinkTypesPaper(themeURL){
    link_types_graph = new joint.dia.Graph;
    link_types_paper = new joint.dia.Paper({
      el: $('#link_types_list'),
      gridSize: 1,
      model: link_types_graph,
      width: $('#link_types_list').width(),
      height: $('#link_types_list').height(),
      interactive: false      });

      link_types_paper.on('cell:pointerclick',
        function(linkView, evt, x, y) {
            selectLink(linkView);
        }
      );
    loadLinkTypesTheme(themeURL);
  }
  /**
  Loads the link type theme specified by the JSON file at the URL provided
  @param {string} url - URL pointing to the theme file with the link types definition
  */
  function loadLinkTypesTheme(url){

    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          link_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfLinkTypesPaper();
          positionLinkTypesOnPaper();
          makeLinkTypesNotInteractive();
          //select first link type
          selectLink(link_types_graph.getLinks()[0].findView(link_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------


  }

  function calculateSizeOfLinkTypesPaper(){
    var numberOfTypes = link_types_graph.getLinks().length;
    link_types_paper.setDimensions(linkTypeCellMaxWidth + linkTypeCellDefaultX, linkTypeCellHeight*numberOfTypes);
    link_types_paper.render();
  }

  function positionLinkTypesOnPaper(){

    var linkTypes = link_types_graph.getLinks();

    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      var currentY = (linkTypeCellHeight * i) + linkTypeCellDefaultY;
      currentLinkType.prop("source", {"x":linkTypeCellDefaultX,"y":currentY});
      currentLinkType.prop("target", {"x":120,"y":currentY});
    }
    link_types_paper.render();
  }

  function makeLinkTypesNotInteractive(){
    var linkTypes = link_types_graph.getLinks();
    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      link_types_paper.findViewByModel(currentLinkType).options.interactive = false
    }
    link_types_paper.render();
  }

  function initializeBackgroundsPaper(themeURL){
    //console.log("initializeBackgroundsPaper");
    backgrounds_graph = new joint.dia.Graph;

    backgrounds_paper = new joint.dia.Paper({
      el: $('#backgrounds_list'),
      gridSize: 1,
      model: backgrounds_graph,
      width: backgroundPaperWidth,
      height: backgroundPaperHeight,
      interactive: false });

    backgrounds_paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {
          selectBackgroundCell(cellView);
      }
    );

    loadBackgroundsTheme(themeURL);
    backgrounds_paper.render();

  }

  function initializeNodeTypesPaper(themeURL){

    node_types_graph = new joint.dia.Graph;

    node_types_paper = new joint.dia.Paper({
      el: $('#node_types_list'),
      gridSize: 1,
      model: node_types_graph,
      width: $('#node_types_list').width(),
      height: $('#node_types_list').height(),
      interactive: false      });

    node_types_paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {
          selectNodeTypeCell(cellView);
      }
    );

    loadNodeTypesTheme(themeURL);
  }

  /**
  Loads the backgrounds theme specified by the JSON file at the URL provided
  @param {string} url - URL pointing to the theme file with the backgrounds definition
  */
  function loadBackgroundsTheme(url){
    //console.log("loadBackgroundsTheme");
    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          //console.log("onreadystatechange (backgrounds)!");
          backgrounds_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfBackgroundsPaper();
          positionBackgroundsOnPaper();
          //select first node type
          selectBackgroundCell(backgrounds_graph.getElements()[0].findView(backgrounds_paper));
          backgrounds_paper.render();
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }

  /**
  Loads the type defintions included in the JSON file located at 'url'
  @param {string} url - URL pointing to the JSON type definitions file 
  */
  function loadTypeDefinitions(url){
    //----loading JSON WITH TYPE DEFINITIONS-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          //console.log(xobj.responseText);
          typeDefinitionsJSON = JSON.parse(xobj.responseText);
          //console.log(typeDefinitionsJSON);
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }
  /**
  Loads the node type theme specified by the JSON at the URL provided
  @param {string} url - URL pointing to the theme file with the definition of the node types
  */
  function loadNodeTypesTheme(url){
    //console.log("loadNodeTypesTheme");
    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          //console.log(xobj.responseText);
          node_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfNodeTypesPaper();
          positionNodeTypesOnPaper();
          makeNodeTypesNotInteractive();
          //select first node type
          selectNodeTypeCell(node_types_graph.getElements()[0].findView(node_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }

  function makeNodeTypesNotInteractive(){
    console.log("makeNodeTypesNotInteractive");
    for(var i=0;i<node_types_graph.getElements().length;i++){
      var currentNodeType = node_types_graph.getElements()[i];
      currentNodeType.attr("image/magnet","");
      currentNodeType.attr("text/magnet","");
    }
  }

  function calculateSizeOfNodeTypesPaper(){
    var numberOfTypes = node_types_graph.getElements().length;
    node_types_paper.setDimensions(100, nodeTypeCellHeight*numberOfTypes);
    node_types_paper.render();
  }

  function positionNodeTypesOnPaper(){

    var nodeTypes = node_types_graph.getElements();
    for(var i=0; i<nodeTypes.length;i++){
      var currentNodeType = nodeTypes[i];
      var currentY = nodeTypeCellHeight * i;
      currentNodeType.prop("position", {"x":nodeTypeCellDefaultX,"y":currentY});
      var currentText = currentNodeType.attr("text/text");
      var brokenText = joint.util.breakText(currentText, { width: nodeTypeCellMaxWidth });
      //console.log(currentText,brokenText);
      currentNodeType.attr("text/text", brokenText);
    }
    node_types_paper.render();
  }

  function calculateSizeOfBackgroundsPaper(){
    console.log("calculateSizeOfBackgroundsPaper");
    var numberOfBackgrounds = backgrounds_graph.getElements().length;
    backgrounds_paper.setDimensions(500, backgroundCellHeight*numberOfBackgrounds);
  }

  function positionBackgroundsOnPaper(){
    console.log("positionBackgroundsOnPaper");
    var backgrounds = backgrounds_graph.getElements();
    for(var i=0; i<backgrounds.length;i++){
      var currentBackground = backgrounds[i];
      var currentY = backgroundCellHeight * i;
      currentBackground.prop("position", {"x":backgroundCellDefaultX,"y":currentY});
      var currentText = currentBackground.attr("text/text");
      var brokenText = joint.util.breakText(currentText, { width: backgroundCellMaxWidth });
      //console.log(currentText,brokenText);
      currentBackground.attr("text/text", brokenText);
    }
  }

  function test(){
    protein_node_type = new rect({
        position: { x: 10, y: 10 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#2ECC71', stroke: '#27AE60', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Protein' },
            name: 'Protein'
        }
    });

    organism_node_type = new rect({
        position: { x: 10, y: 60 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#FFC72E', stroke: '#FFA42E', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Organism' },
            name: 'Organism'
        }
    });

    node_types_graph.addCell(protein_node_type);
    node_types_graph.addCell(organism_node_type);

  }

  function exportToJSON(){
    if(selectedCell){
      selectNodeCell(selectedCell,false); // so that the selected node is not saved with bold-style text
    }
    downloadJSON(JSON.stringify(graph.toJSON()));
  }

  function selectNodeCell(cellView, flag){

    console.log("selectedNodeCell", flag);

    var newCellSelected = true;
    if(selectedCell){
      newCellSelected = cellView.id != selectedCell.id;
    }

    var nodeCells = graph.getElements();

    for (var i = 0; i < nodeCells.length; i++) {
      var currentCell = nodeCells[i];
      if(currentCell.attributes.id == cellView.model.id){
          selectedCell = currentCell.findView(paper);
          if(flag){
            currentCell.attr('text/font-weight',"bold");
          }else{
            currentCell.attr('text/font-weight',"normal");
          }
        }
    }

    if(flag){
      if(newCellSelected){
        initializeSelectionRect();
      }
    }else{
      if(selectionRectCell){
        selectionRectCell.remove();
        selectionRectCell = null;
      }
    }

  }

  function selectNodeTypeCell(cellView){

    //console.log("selectNodeTypeCell");

    var nodeTypeCells = node_types_graph.getElements();
    for (var i = 0; i < nodeTypeCells.length; i++) {
      var currentCell = nodeTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){
          selectedNodeTypeCell = currentCell;
          //console.log(selectedNodeTypeCell);
          currentCell.attr('text/font-weight',"bold");
      }else {
          currentCell.attr('text/font-weight',"normal");
      }
    }
  }

  function selectLink(cellView){
    //console.log("selectLink!");
    var linkTypeCells = link_types_graph.getLinks();

    for (var i = 0; i < linkTypeCells.length; i++) {
      var currentCell = linkTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){

          selectedLinkTypeCell = currentCell;
          currentCell.label(0,{ attrs: { text: { 'font-weight': 'bold', 'font-size': 16 } } });
          link_types_paper.defaultLink = selectedLinkTypeCell;
          //console.log("selected",currentCell.label(0));
      }else {
        currentCell.label(0,{ attrs: { text: { 'font-weight': 'normal', 'font-size': 10  } } });
        //console.log("rest",currentCell.label(0));
      }
    }

    //console.log(link_types_paper.options);
  }

  function selectBackgroundCell(cellView){

    //console.log("selectBackgroundCell");

    var backgroundCells = backgrounds_graph.getElements();

    for (var i = 0; i < backgroundCells.length; i++) {

      var currentBackground = backgroundCells[i];

      if(currentBackground.attributes.id == cellView.model.id){
          selectedBackgroundCell = currentBackground;
          //console.log(selectedNodeTypeCell);
          currentBackground.attr('text/font-weight',"bold");
      }else {
          currentBackground.attr('text/font-weight',"normal");
      }
    }

    //console.log("done with select!");
  }

  <!-- ++++++++++++++++ NODE CREATION METHODS +++++++++++ -->
  var createNodeRect = function(elm, x, y, label, widthValue, heightValue, rxValue, ryValue, fillValue, strokeValue, strokeWidthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        size: { width: widthValue, height: heightValue},
        attrs: {
          rect: { rx: rxValue, ry: ryValue, fill: fillValue, stroke: strokeValue, 'stroke-width': strokeWidthValue, magnet: true},
          text: { 'font-size': 10, fill: '#333', text: label},
          name: label

          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createBackgroundBox = function(x, y, widthValue, heightValue, fillValue) {
      var cell = new rect({
        position: { x: x, y: y },
        size: { width: widthValue, height: heightValue},
        attrs: {
          rect: { fill: fillValue}

          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeEllipse = function(elm, x, y, label, widthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        attrs: {
          size: { width: widthValue},
          text: { 'font-size': 10, fill: '#333', text: label , magnet: true},
          name: label,
          magnet: true
          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeImage = function(imgURI, x, y, widthValue, heightValue, label){
    var cell = new joint.shapes.basic.Image({
      position: { x: x, y: y },
      size: { width: widthValue, height: heightValue},
      attrs: {
        name: label,
        text: {text: label},
        magnet: true,
        image : {
            "xlink:href" : imgURI,
            width : widthValue,
            height : heightValue,
            magnet: true
          }
        }
    });
    graph.addCell(cell);
    return cell;
  }
  var createProtein = function(x, y) {
    return createNodeImage("images/protein.png", x, y, 100, 60, 'Protein');
      //return createNodeRect(rect, x, y, 'Protein', 80, 30, 2, 2, '#2ECC71', '#27AE60', 2);
  };
  var createOrganism = function(x, y) {
    return createNodeImage("images/biographika_logo_tiny.svg", x, y, 60, 60, 'Organism');
      //return createNodeEllipse(ellipse, x, y, 'Organism', 100);
  };

  function cloneCellAt(cell, x, y){
      var clonedCell = cell.clone();
      clonedCell.prop("position", {"x":x,"y":y});
      if(clonedCell.attr("image/width")){
        clonedCell.attr("image/magnet","true");
      }else{
        clonedCell.attr("text/magnet","true");
      }
      clonedCell.attr('text/font-weight',"normal");
      graph.addCell(clonedCell);
      clonedCell.toFront();
      return clonedCell;
  }


  function downloadJSON(jsonContent){

    var blob = null,
        objectUrl = null,
        dataUrl = null,
        filename = "diagram.json";


    if(window.Blob){
      // use Blob if available
      blob = new Blob([jsonContent], {type: 'text/xml'});
      objectUrl = window.URL.createObjectURL(blob);
    }
    else {
      // else use dataURI
      dataUrl = 'data:text/csv;charset=UTF-8,' + encodeURIComponent(jsonContent);
    }

    if (navigator.msSaveBlob) { // IE11+ : (has Blob, but not a[download])
      navigator.msSaveBlob(blob, filename);
    } else if (navigator.msSaveOrOpenBlob) { // IE10+ : (has Blob, but not a[download])
      navigator.msSaveOrOpenBlob(blob, filename);
    } else {
      // A-download
      var anchor = document.createElement('a');
      anchor.setAttribute('href', (window.Blob) ? objectUrl : dataUrl);
      anchor.setAttribute('download', filename || 'graph.' + extension);

      // Firefox requires the link to be added to the DOM before it can be clicked.
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
    }

    if (objectUrl) {
      setTimeout(function() { // Firefox needs a timeout
        window.URL.revokeObjectURL(objectUrl);
      }, 0);
    }

  }

  function onBodyLoad(){
    console.log("onBodyLoad");
    initializeJoint();

    currentBackgroundThemeURL = defaultBackgroundThemeURL;
    currentNodeTypeThemeURL = defaultElementsThemeURL;
    currentLinkTypeThemeURL = defaultLinksThemeURL;

    loadConfigJSON();
  }

  function zoomIn(){
      paperScale += (paperScale * paperScaleFactor);
      paper.scale(paperScale, paperScale);
      paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function zoomOut(){
    paperScale -= (paperScale * paperScaleFactor);
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function resetZoom(){
    paperScale = initialPaperScale;
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }



  function getDefaultLink(){
    //console.log("getDefaultLink");
    if(selectedLinkTypeCell){
      //console.log("true");
      var tempLink = selectedLinkTypeCell.clone();
      tempLink.label(0,{ attrs: { text: { 'font-weight': 'normal', 'font-size': 10  } } });
      return tempLink;
    }else{
      //console.log("false");
      return new joint.dia.Link();
    }

  }

  function makeLinksInteractive(flag){

    var links = graph.getLinks();

    if(!flag){
      $('.link-tools .tool-remove').css({"display":"none"});
      $('.link-tools .tool-options').css({"display":"none"});
    }else{
      $('.link-tools .tool-remove').css({"display":""});
      $('.link-tools .tool-options').css({"display":""});
    }

    //making links not editable
    for(var i=0; i<links.length;i++){
      var currentLink = links[i];
      var currentView = currentLink.findView(paper);
      if(!flag){
        currentView.options.interactive = false;
      }else{
        currentView.options.interactive = true;
      }
    }
  }

  function makeElementsInteractive(flag){

    console.log("makeElementsInteractive");

    var nodes = graph.getElements();

    for(var i=0; i<nodes.length;i++){
      var currentNode = nodes[i];
      var currentView = currentNode.findView(paper);
      console.log("currentNode", currentNode);
      console.log("currentView", currentView);
      if(currentNode != backgroundBox && currentNode != currentBackgroundCell){
        if( !flag ){
          currentView.options.interactive = false;
          currentNode.attr("image/magnet","");
        }else{
          currentNode.attr("image/magnet","true");
          currentView.options.interactive = true;
        }
      }
    }
  }


  function isLinkInvalid(link){
    var linkToBackgroundBox = link.prop('target/id') == backgroundBox.id;
    var linkToBackground = false;
    if(currentBackgroundCell){
      linkToBackground = link.prop('target/id') == currentBackgroundCell.id;
    }
    return (!link.prop('source/id') || !link.prop('target/id') || linkToBackgroundBox || linkToBackground);
  }

  function rotateCellToTheRight(){
     //console.log("rotateCellToTheRight");
     if(selectedCell){

       var currentDegreesSt = selectedCell.model.attr("image/transform");
       var currentDegrees = 0;

       if(currentDegreesSt){
         currentDegrees = parseFloat(currentDegreesSt.split("(")[1].split(")")[0]);
       }
       var newDegrees = currentDegrees - rotateCellFactor;
       var rotationCenterPointX = selectedCell.model.attr("image/width")/2;
       var rotationCenterPointY = selectedCell.model.attr("image/height")/2;
       selectedCell.model.attr("image/transform","rotate("+newDegrees+","
            + rotationCenterPointX + "," + rotationCenterPointY + ")");
     }
  }

  function rotateCellToTheLeft(){
    //console.log("rotateCellToTheLeft");

    if(selectedCell){

      var currentDegreesSt = selectedCell.model.attr("image/transform");
      var currentDegrees = 0;

      if(currentDegreesSt){
        currentDegrees = parseFloat(currentDegreesSt.split("(")[1].split(")")[0]);
      }
      var newDegrees = currentDegrees + rotateCellFactor;
      var rotationCenterPointX = selectedCell.model.attr("image/width")/2;
      var rotationCenterPointY = selectedCell.model.attr("image/height")/2;
      selectedCell.model.attr("image/transform","rotate("+newDegrees+","
           + rotationCenterPointX + "," + rotationCenterPointY + ")");
    }
  }

  function bringSelectedCellToFront(){
    if(selectedCell){
      if(selectionRectCell){
        selectionRectCell.toFront();
      }
      selectedCell.model.toFront();
    }
  }

  function bringSelectedCellToBack(){
    if(selectedCell){
      selectedCell.model.toBack();
      if(selectionRectCell){
        selectionRectCell.toBack();
      }
      if(currentBackgroundCell){
        currentBackgroundCell.toBack();
      }
      backgroundBox.toBack();
      paper.render();
    }
  }

  function updatePaperDimensionsBasedOnTextInputs(){
    //---update dimension values on text inputs
    var tempWidth = $('#inputWidth').prop('value');
    var tempHeight = $('#inputHeight').prop('value');
    paperInitialWidth = tempWidth;
    paperInitialHeight = tempHeight;
    updatePaperDimensions(tempWidth, tempHeight);
  }

  function updatePaperDimensions(tempWidth, tempHeight){
    //console.log("updatePaperDimensions");
    paper.setDimensions(tempWidth,tempHeight);
    updateBackgroundBoxDimensions(tempWidth, tempHeight);
    paper.render();
  }

  function updateBackgroundBoxDimensions(widthValue, heightValue){
      backgroundBox.prop("size", {"width":widthValue,"height":heightValue});
  }

  function onStageDown(evt, x, y){
    //console.log("onStageDown");

    pointerDownClientX = evt.clientX;
    pointerDownClientY = evt.clientY;

    lastPositionMouseX = pointerDownClientX;
    lastPositionMouseY = pointerDownClientY;

    if(document.getElementById("lockDiagramCheckBox").checked == true){
      paperIsPanning = true;
    }
  }

  function onBackgroundOrBackgroundBoxClick(evt, x, y){
    //console.log("onBackgroundOrBackgroundBoxClick");
    if(selectedCell){
        selectNodeCell(selectedCell, false);
    }
    if(document.getElementById("lockDiagramCheckBox").checked != true){
      if(!selectedNodeTypeCell){
        alert("Please select a node type first");
        openDialogSelectNodeType();
      }else{
        var newCell = cloneCellAt(selectedNodeTypeCell,x,y);
        selectNodeCell(newCell.findView(paper), true);
      }
    }else{
       paperIsPanning = true;
    }
  }

  function updatePaperDimensionsTextInputs(width, height){
    $('#inputWidth').prop('value',width);
    $('#inputHeight').prop('value',height);
  }

  function onSetBackgroundButtonClick(){
    $('#background_dialog').modal({
         show: true
     });
  }

  function onShowMetadataButtonClick(){
    if(!selectedCell){
      alert("Please select a cell");
    }else{
      loadSelectedCellMetadataIntoDialog();
      $('#metadata_dialog').modal({
        show: true
      })
    }
  }

  function loadSelectedCellMetadataIntoDialog(){
    if(selectedCell){

      var tempNodeType = selectedCell.model.prop("node_type");
      if(!tempNodeType){
        tempNodeType = selectedCell.model.attr("node_type");
      }
      //console.log("selectedCell.model",selectedCell.model);
      //console.log("tempNodeType: " + tempNodeType);

      var jsonForSelectedCell = typeDefinitionsJSON.nodes[tempNodeType];

      //cleaning previous form fields..
      var divContents = document.getElementById("metadata_form").childNodes;
      for(var i=0; i<divContents.length; i++){
        divContents[i].remove();
      }

      //console.log("typeDefinitionsJSON",typeDefinitionsJSON);
      //console.log("jsonForSelectedCell", jsonForSelectedCell);

      var schema = jsonForSelectedCell.schema;
      var data = selectedCell.model.prop("data");

      alpacaMetadataForm = $("#metadata_form").alpaca({
      "schema":schema,
      "data":data,
      "postRender": function(control) {
              alpacaMetadataFormControl = control;
              if(readOnlyMode){
                alpacaMetadataFormControl.disable();
              }
          }
      });

    }
  }

  function setSelectedBackground(){
    $('#background_dialog').modal('hide');

    if(currentBackgroundCell){
      //console.log("There already was a background for this diagram...");
      if(currentBackgroundCell.id != selectedBackgroundCell.id){
        //console.log("The background selected is different from the current one");
        currentBackgroundCell.remove();
      }
    }
    //console.log("let's create the new background cell!");

    var newBackgroundCell = selectedBackgroundCell.clone();
    var realSize = newBackgroundCell.prop("real_size");
    var realWidth = realSize.width;
    var realHeight = realSize.height;
    //var nodeType = newBackgroundCell.attr("node_type");
    //console.log(realWidth, realHeight, realSize, nodeType);

    newBackgroundCell.prop("size", {"width":realWidth,"height":realHeight});
    newBackgroundCell.prop("position", {"x":0,"y":0});
    newBackgroundCell.attr("image/magnet","");
    newBackgroundCell.attr("image/width", realWidth);
    newBackgroundCell.attr("image/height", realHeight);
    newBackgroundCell.attr('text/font-weight',"normal");

    graph.addCell(newBackgroundCell);
    newBackgroundCell.toBack();
    backgroundBox.toBack();
    //console.log(newBackgroundCell);
    currentBackgroundCell = newBackgroundCell;
    currentBackgroundCell.findView(paper).options.interactive = false;
    paper.render();
    //console.log("done!");

  }

  function fitPaperToContents(){
    //first the background box is removed so that it does not influence the calculation
    //of the bbox
    backgroundBox.remove();
    paper.render();
    var bbox = paper.getContentBBox();
    //console.log(bbox);
    var tempWidth = bbox.width + bbox.x;
    var tempHeight = bbox.height + bbox.y;
    //console.log(tempWidth, tempHeight);
    $('#inputWidth').prop('value', tempWidth);
    $('#inputHeight').prop('value', tempHeight);
    paperInitialWidth = tempWidth;
    paperInitialHeight = tempHeight;
    updatePaperDimensions(paperInitialWidth, paperInitialHeight);
    initializeBackgroundBox(paperInitialWidth,paperInitialHeight);
  }

  function saveMetadataChanges(){
    $('#metadata_dialog').modal('hide');
    selectedCell.model.prop("data",alpacaMetadataFormControl.getValue());
    //console.log("saveMetadataChanges", selectedCell.model);
  }

  function deletePreviousBackgroundBox(){
    //console.log("deletePreviousBackgroundBox");
    var nodes = graph.getElements();
    for(var i=0; i<nodes.length;i++){
      var currentNode = nodes[i];
      //console.log("currentNode.background_box: " + currentNode.prop("background_box"));
      if( currentNode.prop("background_box") == "true"){
        //console.log("remove previous background cell!! :D");
        currentNode.remove();
      }
    }
  }

  function renameSelectedNode(newLabel){
    //console.log("renameSelectedNode", newLabel);
    var labelLength = newLabel.length;
    console.log("labelLength", labelLength);
    if(labelLength > nodeLabelMaxLength){
      selectedCell.model.attr("text/text",addNewLinesToTextWhenNeeded(newLabel, nodeLabelMaxLength));
    }else{
      selectedCell.model.attr("text/text",newLabel);
    }
  }

  function applyRenameNode(){
    //console.log("applyRenameNode");
    $('#rename_node_dialog').modal('hide');
    renameSelectedNode(document.getElementById("inputNodeName").value);
  }

  function onRenameNodeButtonClick(){
    if(!selectedCell){
      alert("Please select a cell");
    }else{
      $('#rename_node_dialog').modal({
        show: true
      })
      var currentLabel = selectedCell.model.attr("text/text");
      //console.log("currentLabel", currentLabel);
      document.getElementById("inputNodeName").value = currentLabel;
    }
  }

  function openDialogSelectNodeType(){
    $('#node_types_dialog').modal({
         show: true
     });
  }

  function openDialogSelectLinkType(){
    $('#link_types_dialog').modal({
         show: true
     });
  }

  function setSelectedNodeType(){
    $('#node_types_dialog').modal('hide');
    console.log("thumbnail prop:",selectedNodeTypeCell.prop("thumbnail"));
    $('#currentNodeTypeIcon').remove();
    $('#currentNodeTypeImage').attr("src",selectedNodeTypeCell.prop("thumbnail"));
    console.log("done!");
  }

  function setSelectedLinkType(){
    $('#link_types_dialog').modal('hide');
  }

  function initializeSelectionRect(){

    console.log("initializeSelectionRect");

    if(selectedCell){

      console.log("selectedCell = true");

      if(!selectionRectCell){

        var tempPosition = getPositionForSelectionRect();
        tempPosition.x -= 2;
        tempPosition.y -= 2;
        var tempSize = getSizeForSelectionRect();

        //console.log("selectedCell",selectedCell.model);
        //console.log("tempPosition", tempPosition);
        //console.log("tempSize", tempSize);

        selectionRectCell = new rect({
            position: tempPosition,
            size: tempSize,
            attrs: {
                rect: { rx: 2, ry: 2, stroke: '#000000', 'stroke-width': 1, 'stroke-dasharray':"5,5" }
            }
        });
        //console.log(selectionRectCell);
        graph.addCell(selectionRectCell);
        selectionRectCell.toBack();
        if(currentBackgroundCell){
          currentBackgroundCell.toBack();
        }
        backgroundBox.toBack();

      }else{
        updateSelectionRectPosition();
        selectionRectCell.prop("size", getSizeForSelectionRect());
      }

    }

  }

  function updateSelectionRectPosition(){
    //console.log("updateSelectionRectPosition");
    var positionForSelectionRect = getPositionForSelectionRect();
    //console.log("positionForSelectionRect",positionForSelectionRect);
    selectionRectCell.prop("position", positionForSelectionRect);
  }

  function getPositionForSelectionRect(){
    var tempPosition = selectedCell.model.prop('position');
    //console.log("tempPosition", tempPosition);
    tempPosition.x = tempPosition.x;
    tempPosition.y = tempPosition.y;
    return tempPosition;
  }
  function getSizeForSelectionRect(){
    var tempSize = selectedCell.model.prop('size');
    tempSize.width += 4;
    tempSize.height += 4;
    return tempSize;
  }

  function loadConfigJSON(){
    console.log("loadConfigJSON");
    $.getJSON("data/Config.json", function(json) {
        nodeLabelMaxLength = json.label_max_length;
        console.log(nodeLabelMaxLength);
    });
  }

  function addNewLinesToTextWhenNeeded(textSt, maxLineLength){
    console.log("addNewLinesToTextWhenNeeded");
    var lines = textSt.split('\n');
    var result = "";

    for(var i=0; i<lines.length; i++){
      var currentLine = lines[i];
      if(currentLine.length > maxLineLength){

        for(var j=0;j<(currentLine.length/maxLineLength);j++){
          var tempStart = j*maxLineLength;
          if(j<((currentLine.length/maxLineLength) -1)){
            console.log("argh");
            result += currentLine.substr(tempStart, tempStart + maxLineLength) + '\n';
          }else{
            console.log("buh!");
            result += currentLine.substr(tempStart, currentLine.length);
            result += '\n';
          }
        }

      }else{
        result += (currentLine + "\n");
      }
    }

    return result;
  }

	</script>
</body>
</html>
