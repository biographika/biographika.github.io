<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>
  Bio4j Graph Editor
</title>
<!-- Bootstrap Core CSS -->
<link href="css/bootstrap.css" rel="stylesheet" type='text/css'>
<link href="css/jquery-ui.css" rel="stylesheet" type='text/css'>
<style type="text/css">

  body {
      background-color: #f8f8f8;
  }

  .panel {
    margin-right: 10px;
  	margin-left: 10px;
  	margin-top: 10px;
  }

  #wrapper {
      width: 100%;
      height: 100$;
  }

  #page-wrapper {
      background-color: #fff;
  }

  #toolbar {
    width: 100%;
    margin-left: 10px;
    margin-right: 10px;
  }

  .nav-bar-logo{
  	margin-left: 30px;
  	height: 40px;
  }

  .nav-bar-text{
    width: 100%;
  }

 .push {
    height: 63px;
  }
  footer {
      background: #d9edf7;
      padding: 5px 0 5px 0px;
      border-top: 1px solid #4C8DAD;
  }

  .btn-file {
    position: relative;
    overflow: hidden;
  }
  .btn-file input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      background: white;
      cursor: inherit;
      display: block;
  }

  #node_types_list{
    background-color: #F0F0F0;
  }

  #graph-container{
    overflow: auto;
    max-height: 450px;
    min-height: 450px;
    border: 1px solid gray;
    background-color: #dbdbdb;
  }
  #node_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
  }
  #link_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
    min-height: 200px;
  }
  #backgrounds_list{
    overflow-y: auto;
    overflow-x: auto;
    max-height: 450px;
  }

</style>
<link rel="stylesheet" type="text/css" href="css/joint.css" />
<script src="js/joint.js"></script>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/bootstrap.js"></script>
<script type="text/javascript"> if (!window.console) console = {log: function() {}}; </script>
<script type="text/javascript"> window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;</script>
<body onload="onBodyLoad()">
  <div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
      <div class="navbar-header">
		      <a href="index.html" target="_blank" class="pull-left nav-bar-logo"><img src="images/biographika_logo_tiny.svg"></a>
          <a class="navbar-brand"><strong>Biographika: </strong>Bio4j data graph visualization</a>
      </div>
      <!-- /.navbar-static-side -->
    </nav>
    <div id="page-wrapper">
      <div class="panel panel-info">
        <div class="panel-heading">
          <i class="fa fa-fw">
          </i>
            Graph explorer
        </div>
        <!-- /.panel-heading -->
        <div id="toolbar">
          <div class="btn-group btn-block" >
                <span class="btn btn-default btn-file">
                    Load file... <input type="file" accept=".json">
                </span>
                <button type="button" class="btn btn-default dropdown-toggle"
                  data-toggle="dropdown">
                  Export to...
                  <span class="caret"></span>
                </button>
                <ul id="exportDropDownMenu" class="dropdown-menu" >
                  <li><a id="exportToJSONButton" role="button" data-toggle="modal" >JSON</a></li>
                </ul>
                <button id="zoomInButton" onclick="zoomIn()" type="button" class="btn btn-default">Zoom in</button>
                <button id="zoomOutButton" onclick="zoomOut()" type="button" class="btn btn-default">Zoom out</button>
                <button id="resetZoomButton" onclick="resetZoom()" type="button" class="btn btn-default">Reset zoom</button>
                <div class="checkbox">
                  <label><input id="deleteNodeOnClickCheckBox" type="checkbox" >Delete node on click</label>
                </div>
                <!-- delete node on click checkbox -->
                <div class="btn-group">
                    <button type="button" data-toggle="dropdown" class="btn btn-default dropdown-toggle">Themes <span class="caret"></span></button>
                    <ul id="themesDropDownMenu" class="dropdown-menu">
                        <li class="dropdown-header">BIOLOGY</li>
                        <li><a id="proteinsThemeButton" role="button">Proteins</a></li>
                        <li class="dropdown-header">GENERAL</li>
                        <li><a id="doPlanningThemeButton" role="button">Doplanning</a></li>
                    </ul>
                    <button id="rotateRightButton" onclick="rotateCellToTheRight()" type="button" class="btn btn-default">Rotate to right</button>
                    <button id="rotateLeftButton" onclick="rotateCellToTheLeft()" type="button" class="btn btn-default">Rotate to left</button>
                    <button id="bringToFrontButton" onclick="bringSelectedCellToFront()" type="button" class="btn btn-default">Bring to front</button>
                    <button id="bringToBackButton" onclick="bringSelectedCellToBack()" type="button" class="btn btn-default">Bring to back</button>
                    <button id="setBackgroundButton" onclick="onSetBackgroundButtonClick()" type="button" class="btn btn-default">Set background</button>
                    <form class="form-horizontal">
                      <div class="control-group">
                        <span class="control-label">Stage dimensions</span>
                        <div class="controls form-inline">
                            <label for="inputWidth">Width</label>
                            <input onchange="updatePaperDimensionsBasedOnTextInputs()" value="200" type="number" class="input-small" placeholder="Width" id="inputWidth" min="200" max="2000">
                            <label for="inputHeight">Height</label>
                            <input onchange="updatePaperDimensionsBasedOnTextInputs()" value="100" type="number" class="input-small" placeholder="Height" id="inputHeight" min="100" max="1500">
                        </div>
                      </div>
                    </form>
                    <div class="checkbox">
                      <label><input id="lockDiagramCheckBox" type="checkbox" >Lock diagram</label>
                    </div>
                    <!-- lock diagram checkbox -->
                </div>
                <!-- button group -->
          </div>
          <!-- button group -->
        </div>
        <!-- toolbar -->
        <div class="panel-body">
          <div class="row">
            <div id="link_types_list" class="col-xs-2">
            </div>
            <div id="graph-container" class="col-xs-8">
            </div>
            <div id="node_types_list" class="col-xs-2">
            </div>
          </div>
        </div>
        <!-- /.panel-body -->
      </div>

    </div>
    <!-- page-wrapper -->
  </div>
  <div class="push"></div>
  <footer>
    <div class="container">
      <p>This example is part of <a href="http://www.biographika.com/" rel="author">Biographika</a> project.  100% of the code is open source and released under <a href="http://www.gnu.org/licenses/agpl-3.0.en.html" rel="external">AGPLv3</a> license.</p>
    </div>
  </footer>
  <div id="background_dialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="mainLabel">Background selector</h4>
        </div>
        <div class="modal-body">
          <div id="backgrounds_list">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" onclick="setSelectedBackground()" class="btn btn-primary">Set background</button>
        </div>
      </div>
    </div>

  </div>

  <script type="text/javascript">


 <!-- +++++++++++++++++++ MAIN VARS ++++++++++++++++++++++++ -->
 var graph, node_types_graph, link_types_graph, backgrounds_graph, paper, node_types_paper, link_types_paper, backgrounds_paper, protein_node_type, organism_node_type, genome_element_type, selected_node_type;

 //.......paper panning related vars........
 var paperIsPanning = false;
 var pointerDownClientX;
 var pointerDownClientY;
 var lastPositionMouseX;
 var lastPositionMouseY;
 //.........................................
 //.......paper zooming related vars........
 var paperScale = 1;
 var paperScaleFactor = 0.2;
 var paperInitialWidth = 500;
 var paperInitialHeight = 200;
 //.........................................

 //-----node types cells------------------------
 var nodeTypeCellHeight = 100;
 var nodeTypeCellDefaultX = 15;
 var nodeTypeCellMaxWidth = 80;
 //----------------------------------------------

 //-----link types cells------------------------
 var linkTypeCellHeight = 60;
 var linkTypeCellDefaultX = 15;
 var linkTypeCellDefaultY = 30;
 var linkTypeCellMaxWidth = 120;
 //----------------------------------------------

 //-----background cells------------------------
 var backgroundCellHeight = 250;
 var backgroundCellDefaultX = 15;
 var backgroundCellMaxWidth = 500;
 var backgroundPaperWidth = 500;
 var backgroundPaperHeight = 300;
 //----------------------------------------------

 var selectedNodeTypeCell;
 var selectedLinkTypeCell;
 var selectedBackgroundCell;
 var selectedCell;
 var readOnlyMode = false;
 var currentBackgroundCell = null;

 var rotateCellFactor = 10;

 //-----THEMES URLs------------------------
 var proteinsLinksThemeURL = "data/ProteinsLinksTheme.json";
 var proteinsElementsThemeURL = "data/ProteinsElementsTheme.json";
 var proteinsBackgroundThemeURL = "data/ProteinsBackgroundTheme.json";
 var doPlanningLinksThemeURL = "data/DoPlanningLinksTheme.json";
 var doPlanningElementsThemeURL = "data/DoPlanningElementsTheme.json";
 var defaultLinksThemeURL = proteinsLinksThemeURL;
 var defaultElementsThemeURL = proteinsElementsThemeURL;
 var defaultBackgroundThemeURL = proteinsBackgroundThemeURL;
 //----------------------------------------------

 // Shortcuts.
 var rect = joint.shapes.basic.Rect;
 var path = joint.shapes.basic.Path;
 var circle = joint.shapes.basic.Circle;
 var ellipse = joint.shapes.basic.Ellipse;
 var polygon = joint.shapes.basic.Polygon;
 var polyline = joint.shapes.basic.Polyline;
 var text = joint.shapes.basic.Text;
 var link = joint.dia.Link;
 joint.shapes.basic.DecoratedRect = joint.shapes.basic.Generic.extend({

    markup: '<g class="rotatable"><g class="scalable"><rect/></g><image/><text/></g>',

    defaults: joint.util.deepSupplement({

        type: 'basic.DecoratedRect',
        size: { width: 100, height: 60 },
        attrs: {
            'rect': { fill: '#FFFFFF', stroke: 'black', width: 100, height: 60},
            'text': { 'font-size': 14, text: '', 'ref-x': .5, 'ref-y': .5, ref: 'rect', 'y-alignment': 'middle', 'x-alignment': 'middle', fill: 'black'  },

        }

    }, joint.shapes.basic.Generic.prototype.defaults)
  });
 var decoratedRect = joint.shapes.basic.DecoratedRect;

 var backgroundBox;

 <!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


 <!--===================DOCUMENT EVENT HANDLERS======================== -->
 $(document).mousemove(function( event ) {

   if(paperIsPanning){

     var tempClientX = event.clientX;
     var tempClientY = event.clientY;
     var differenceX = tempClientX - lastPositionMouseX;
     var differenceY = tempClientY - lastPositionMouseY;
     var currentScrollLeft = $("#graph-container").scrollLeft();
     var currentScrollTop = $("#graph-container").scrollTop();

     lastPositionMouseX += differenceX;
     lastPositionMouseY += differenceY;

     /*console.log("tempClientX: ",tempClientX,"tempClientY: ",tempClientY,"currentScrollLeft: ",
          currentScrollLeft,"currentScrollTop: ",currentScrollTop,
          "differenceX: " ,differenceX,"differenceY: " ,differenceY,
          "lastPositionMouseX: " + lastPositionMouseX,
          "lastPositionMousey: " + lastPositionMouseY);*/

     $("#graph-container").scrollLeft(currentScrollLeft + differenceX);
     $("#graph-container").scrollTop(currentScrollTop + differenceY);

     //console.log("mouse move!", pointerDownClientX, tempClientX, pointerDownClientY, tempClientY);
   }
  });
 $(document).mouseup(function( event ) {
    //console.log("mouse up!");
    paperIsPanning = false;
 });

 <!--===================================================================-->

  <!-- LOAD GRAPH BUTTON... -->
  $(document).on('change', '.btn-file :file', function() {
      var input = $(this);
      var file = input.get(0).files[0];
      var fileNameSplit = file.name.split(".");
      var fileType = fileNameSplit[fileNameSplit.length - 1];

      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
  	      var contents = e.target.result;
          //console.log(fileType);
          if(fileType != "json"){
              alert("Please select a .json file");
          }else{
             graph.fromJSON(JSON.parse(contents));

             //var bbox = graph.getBBox(graph.getElements());
             var contentBBox = paper.getContentBBox();
             paperInitialWidth = contentBBox.width + contentBBox.x;
             paperInitialHeight = contentBBox.height + contentBBox.y;

             //console.log(paperInitialWidth, paperInitialHeight);
             //console.log(contentBBox.width, contentBBox.height, contentBBox.x, contentBBox.y);

             console.log("graph loaded!");

             updatePaperDimensionsTextInputs(paperInitialWidth, paperInitialHeight);

             initializeBackgroundBox(paperInitialWidth, paperInitialHeight);
             backgroundBox.toBack();
             updatePaperDimensions(paperInitialWidth,paperInitialHeight);
             paper.render();
          }
        }
        reader.readAsText(file);
      } else {
        alert("Failed to load file");
      }
  });

  <!-- LOCK DIAGRAM CHECKBOX... -->
  $("#lockDiagramCheckBox").click( function(){
      if( $(this).is(':checked') ){
        readOnlyMode = true;
      }else{
        readOnlyMode = false;
      }

      makeLinksInteractive(!readOnlyMode);
      makeElementsInteractive(!readOnlyMode);

      paper.render();
    }
  );


  <!-- EXPORT BUTTONS... -->
  $("#exportDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");
    if(buttonClicked == "exportToJSONButton"){
        exportToJSON();
    }

  });

  <!-- THEMES DROPDOWN... -->
  $("#themesDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");
    if(buttonClicked == "proteinsThemeButton"){
      loadLinksTheme(proteinsLinksThemeURL);
      loadNodeTypesTheme(proteinsElementsThemeURL);
    }else if(buttonClicked == "doPlanningThemeButton"){
      loadLinksTheme(doPlanningLinksThemeURL);
      loadNodeTypesTheme(doPlanningElementsThemeURL);
    }

  });

  <!-- MAKING NODE TYPES LIST ELEMENTS SELECTABLE -->
  $("ul li").click(function() {
    $(this).parent().children().removeClass("active");
    $(this).addClass("active");
  });

  <!-- BACKGROUNDS MODAL DIALOG -->
  $('#background_dialog').on('shown.bs.modal', function () {
    console.log("shown.bs.modal");
    if(!backgrounds_graph){
      console.log("!backgrounds_graph");
      initializeBackgroundsPaper();
    }
  })


  function initializeJoint(){
      //initializeCustomElements();
      initializeGraphPaper();
      initializeNodeTypesPaper();
      initializeLinkTypesPaper();
  }

  function initializeGraphPaper(){
    console.log("initializeGraphPaper");

    graph = new joint.dia.Graph;

    paper = new joint.dia.Paper({
      el: $('#graph-container'),
      gridSize: 1,
      model: graph,
      width: paperInitialWidth,
      height: paperInitialHeight,
      defaultLink: getDefaultLink
    });

    //---update dimension values on text inputs
    $('#inputWidth').attr('value', paperInitialWidth);
    $('#inputHeight').attr('value', paperInitialHeight);

    paper.on("blank:pointerdown",
      function(evt, x, y){
          onStageDown(evt,x,y);
      }
    );

    paper.on("cell:mouseover",
      function(cellView, evt, x, y){
        if(cellView.model == backgroundBox){

        }
      }
    );
    paper.on("cell:mouseout",
      function(evt, x, y){
        //console.log("cell mouse out!");
      }
    );
    paper.on('cell:pointerdown',
      function(cellView, evt, x, y){
        if(cellView.model == backgroundBox || cellView.model == currentBackgroundCell){
          onStageDown(evt,x,y);
        }
      }
    );
    paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {

        if(cellView.model == backgroundBox){
          onStageClick(evt,x,y);
        }else if(cellView.model == currentBackgroundCell){
          onStageClick(evt,x,y);
        }else{
          console.log("cell:pointerclick!");

          if(document.getElementById("deleteNodeOnClickCheckBox").checked && !readOnlyMode){
            //console.log("remove!");
            cellView.remove();
          }

          if(readOnlyMode){
            if(selectedCell){
                selectNodeCell(selectedCell, false);
            }
            selectNodeCell(cellView, true);
          }
        }
      }
    );

    paper.on('cell:pointerup', function(cellView) {
        if (cellView.model instanceof joint.dia.Link){
          var tempLink = cellView.model;
          if(isLinkInvalid(tempLink)){
            tempLink.remove();
          }
        }
    });

    initializeBackgroundBox(paperInitialWidth, paperInitialHeight);

  }

  function initializeBackgroundBox(width, height){
    backgroundBox  = createBackgroundBox(0, 0, width, height, '#FFFFFF');
    backgroundBox.findView(paper).options.interactive = false;
  }

  function initializeLinkTypesPaper(){
    link_types_graph = new joint.dia.Graph;
    link_types_paper = new joint.dia.Paper({
      el: $('#link_types_list'),
      gridSize: 1,
      model: link_types_graph,
      width: $('#link_types_list').width(),
      height: $('#link_types_list').height(),
      interactive: false      });

      link_types_paper.on('cell:pointerclick',
        function(linkView, evt, x, y) {
            selectLink(linkView);
        }
      );
    loadLinksTheme(defaultLinksThemeURL);
  }

  function loadLinksTheme(url){

    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          link_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfLinkTypesPaper();
          positionLinkTypesOnPaper();
          makeLinkTypesNotInteractive();
          //select first link type
          selectLink(link_types_graph.getLinks()[0].findView(link_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------


  }

  function calculateSizeOfLinkTypesPaper(){
    var numberOfTypes = link_types_graph.getLinks().length;
    link_types_paper.setDimensions(linkTypeCellMaxWidth + linkTypeCellDefaultX, linkTypeCellHeight*numberOfTypes);
    link_types_paper.render();
  }

  function positionLinkTypesOnPaper(){

    var linkTypes = link_types_graph.getLinks();

    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      var currentY = (linkTypeCellHeight * i) + linkTypeCellDefaultY;
      currentLinkType.prop("source", {"x":linkTypeCellDefaultX,"y":currentY});
      currentLinkType.prop("target", {"x":120,"y":currentY});
    }
    link_types_paper.render();
  }

  function makeLinkTypesNotInteractive(){
    var linkTypes = link_types_graph.getLinks();
    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      link_types_paper.findViewByModel(currentLinkType).options.interactive = false
    }
    link_types_paper.render();
  }

  function initializeBackgroundsPaper(){
    backgrounds_graph = new joint.dia.Graph;

    backgrounds_paper = new joint.dia.Paper({
      el: $('#backgrounds_list'),
      gridSize: 1,
      model: backgrounds_graph,
      width: backgroundPaperWidth,
      height: backgroundPaperHeight,
      interactive: false });

    backgrounds_paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {
          selectBackgroundCell(cellView);
      }
    );

    loadBackgroundsTheme(defaultBackgroundThemeURL);
  }

  function initializeNodeTypesPaper(){

    node_types_graph = new joint.dia.Graph;

    node_types_paper = new joint.dia.Paper({
      el: $('#node_types_list'),
      gridSize: 1,
      model: node_types_graph,
      width: $('#node_types_list').width(),
      height: $('#node_types_list').height(),
      interactive: false      });

    node_types_paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {
          selectNodeTypeCell(cellView);
      }
    );

    loadNodeTypesTheme(defaultElementsThemeURL);
  }

  function loadBackgroundsTheme(url){
    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          backgrounds_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfBackgroundsPaper();
          positionBackgroundsOnPaper();
          //select first node type
          selectBackgroundCell(backgrounds_graph.getElements()[0].findView(backgrounds_paper));
          console.log("holaaaaaaaaaaaaaaaaaaaaaa!");
          backgrounds_paper.render();
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }

  function loadNodeTypesTheme(url){
    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          node_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfNodeTypesPaper();
          positionNodeTypesOnPaper();
          //select first node type
          selectNodeTypeCell(node_types_graph.getElements()[0].findView(node_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }

  function calculateSizeOfNodeTypesPaper(){
    var numberOfTypes = node_types_graph.getElements().length;
    node_types_paper.setDimensions(100, nodeTypeCellHeight*numberOfTypes);
    node_types_paper.render();
  }

  function positionNodeTypesOnPaper(){

    var nodeTypes = node_types_graph.getElements();
    for(var i=0; i<nodeTypes.length;i++){
      var currentNodeType = nodeTypes[i];
      var currentY = nodeTypeCellHeight * i;
      currentNodeType.prop("position", {"x":nodeTypeCellDefaultX,"y":currentY});
      var currentText = currentNodeType.attr("text/text");
      var brokenText = joint.util.breakText(currentText, { width: nodeTypeCellMaxWidth });
      //console.log(currentText,brokenText);
      currentNodeType.attr("text/text", brokenText);
    }
    node_types_paper.render();
  }

  function calculateSizeOfBackgroundsPaper(){
    var numberOfBackgrounds = backgrounds_graph.getElements().length;
    backgrounds_paper.setDimensions(500, backgroundCellHeight*numberOfBackgrounds);
    backgrounds_paper.render();
  }

  function positionBackgroundsOnPaper(){

    var backgrounds = backgrounds_graph.getElements();
    for(var i=0; i<backgrounds.length;i++){
      var currentBackground = backgrounds[i];
      var currentY = backgroundCellHeight * i;
      currentBackground.prop("position", {"x":backgroundCellDefaultX,"y":currentY});
      var currentText = currentBackground.attr("text/text");
      var brokenText = joint.util.breakText(currentText, { width: backgroundCellMaxWidth });
      //console.log(currentText,brokenText);
      currentBackground.attr("text/text", brokenText);
    }
    backgrounds_paper.render();
  }

  function test(){
    protein_node_type = new rect({
        position: { x: 10, y: 10 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#2ECC71', stroke: '#27AE60', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Protein' },
            name: 'Protein'
        }
    });

    organism_node_type = new rect({
        position: { x: 10, y: 60 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#FFC72E', stroke: '#FFA42E', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Organism' },
            name: 'Organism'
        }
    });

    node_types_graph.addCell(protein_node_type);
    node_types_graph.addCell(organism_node_type);

  }

  function exportToJSON(){
    downloadJSON(JSON.stringify(graph.toJSON()));
  }

  function selectNodeCell(cellView, flag){

    console.log("selectNodeTypeCell");


    var nodeCells = graph.getElements();

    for (var i = 0; i < nodeCells.length; i++) {
      var currentCell = nodeCells[i];
      // console.log("currentCell.attributes.id", currentCell.attributes.id);
      // console.log("cellView",cellView);
      // console.log("cellView.model",cellView.model);
      // console.log("cellView.model.id",cellView.model.id);
      if(currentCell.attributes.id == cellView.model.id){
          selectedCell = currentCell.findView(paper);
          if(flag){
            currentCell.attr('text/font-weight',"bold");
          }else{
            currentCell.attr('text/font-weight',"normal");
          }
        }
    }
  }

  function selectNodeTypeCell(cellView){

    var nodeTypeCells = node_types_graph.getElements();
    for (var i = 0; i < nodeTypeCells.length; i++) {
      var currentCell = nodeTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){
          selectedNodeTypeCell = currentCell;
          //console.log(selectedNodeTypeCell);
          currentCell.attr('text/font-weight',"bold");
      }else {
          currentCell.attr('text/font-weight',"normal");
      }
    }
  }

  function selectLink(cellView){
    console.log("selectLink!");
    var linkTypeCells = link_types_graph.getLinks();

    for (var i = 0; i < linkTypeCells.length; i++) {
      var currentCell = linkTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){

          selectedLinkTypeCell = currentCell;
          currentCell.label(0,{ attrs: { text: { 'font-weight': 'bold', 'font-size': 16 } } });
          link_types_paper.defaultLink = selectedLinkTypeCell;
          //console.log("selected",currentCell.label(0));
      }else {
        currentCell.label(0,{ attrs: { text: { 'font-weight': 'normal', 'font-size': 10  } } });
        //console.log("rest",currentCell.label(0));
      }
    }

    console.log(link_types_paper.options);
  }

  function selectBackgroundCell(cellView){

    console.log("selectBackgroundCell");

    var backgroundCells = backgrounds_graph.getElements();

    for (var i = 0; i < backgroundCells.length; i++) {

      var currentBackground = backgroundCells[i];

      if(currentBackground.attributes.id == cellView.model.id){
          selectedBackgroundCell = currentBackground;
          //console.log(selectedNodeTypeCell);
          currentBackground.attr('text/font-weight',"bold");
      }else {
          currentBackground.attr('text/font-weight',"normal");
      }
    }

    console.log("done with select!");
  }

  <!-- ++++++++++++++++ NODE CREATION METHODS +++++++++++ -->
  var createNodeRect = function(elm, x, y, label, widthValue, heightValue, rxValue, ryValue, fillValue, strokeValue, strokeWidthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        size: { width: widthValue, height: heightValue},
        attrs: {
          rect: { rx: rxValue, ry: ryValue, fill: fillValue, stroke: strokeValue, 'stroke-width': strokeWidthValue, magnet: true},
          text: { 'font-size': 10, fill: '#333', text: label},
          name: label

          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createBackgroundBox = function(x, y, widthValue, heightValue, fillValue) {
      var cell = new rect({
        position: { x: x, y: y },
        size: { width: widthValue, height: heightValue},
        attrs: {
          rect: { fill: fillValue}

          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeEllipse = function(elm, x, y, label, widthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        attrs: {
          size: { width: widthValue},
          text: { 'font-size': 10, fill: '#333', text: label , magnet: true},
          name: label,
          magnet: true
          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeImage = function(imgURI, x, y, widthValue, heightValue, label){
    var cell = new joint.shapes.basic.Image({
      position: { x: x, y: y },
      size: { width: widthValue, height: heightValue},
      attrs: {
        name: label,
        text: {text: label},
        magnet: true,
        image : {
            "xlink:href" : imgURI,
            width : widthValue,
            height : heightValue,
            magnet: true
          }
        }
    });
    graph.addCell(cell);
    return cell;
  }
  var createProtein = function(x, y) {
    return createNodeImage("images/protein.png", x, y, 100, 60, 'Protein');
      //return createNodeRect(rect, x, y, 'Protein', 80, 30, 2, 2, '#2ECC71', '#27AE60', 2);
  };
  var createOrganism = function(x, y) {
    return createNodeImage("images/biographika_logo_tiny.svg", x, y, 60, 60, 'Organism');
      //return createNodeEllipse(ellipse, x, y, 'Organism', 100);
  };

  function cloneCellAt(cell, x, y){
      var clonedCell = cell.clone();
      clonedCell.prop("position", {"x":x,"y":y});
      clonedCell.attr("image/magnet","true");
      clonedCell.attr('text/font-weight',"normal");
      graph.addCell(clonedCell);
      clonedCell.toFront();
  }


  function downloadJSON(jsonContent){

    var blob = null,
        objectUrl = null,
        dataUrl = null,
        filename = "diagram.json";


    if(window.Blob){
      // use Blob if available
      blob = new Blob([jsonContent], {type: 'text/xml'});
      objectUrl = window.URL.createObjectURL(blob);
    }
    else {
      // else use dataURI
      dataUrl = 'data:text/csv;charset=UTF-8,' + encodeURIComponent(jsonContent);
    }

    if (navigator.msSaveBlob) { // IE11+ : (has Blob, but not a[download])
      navigator.msSaveBlob(blob, filename);
    } else if (navigator.msSaveOrOpenBlob) { // IE10+ : (has Blob, but not a[download])
      navigator.msSaveOrOpenBlob(blob, filename);
    } else {
      // A-download
      var anchor = document.createElement('a');
      anchor.setAttribute('href', (window.Blob) ? objectUrl : dataUrl);
      anchor.setAttribute('download', filename || 'graph.' + extension);

      // Firefox requires the link to be added to the DOM before it can be clicked.
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
    }

    if (objectUrl) {
      setTimeout(function() { // Firefox needs a timeout
        window.URL.revokeObjectURL(objectUrl);
      }, 0);
    }

  }

  function onBodyLoad(){
    initializeJoint();
     //var tempHeight = document.getElementById("graph-container").offsetHeight;
     //var tempWidth = document.getElementById("graph-container").offsetWidth;
     //paper.setDimensions(tempWidth,tempHeight);
     //console.log(tempHeight, tempWidth);
  }

  function zoomIn(){
      paperScale = paperScale + paperScaleFactor;
      paper.scale(paperScale, paperScale);
      paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function zoomOut(){
    paperScale = paperScale - paperScaleFactor;
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function resetZoom(){
    paperScale = 1;
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }

  function initializeCustomElements(){
    console.log("Initializing custom elements...");
    // Create a custom element.
    // ------------------------

    joint.shapes.html = {};
    joint.shapes.html.Element = joint.shapes.basic.Rect.extend({
        defaults: joint.util.deepSupplement({
            type: 'html.Element',
            attrs: {
                rect: { stroke: 'none', 'fill-opacity': 0 }
            }
        }, joint.shapes.basic.Rect.prototype.defaults)
    });

    // Create a custom view for that element that displays an HTML div above it.
    // -------------------------------------------------------------------------

    joint.shapes.html.ElementView = joint.dia.ElementView.extend({

        template: [
            '<div class="html-element">',
            '<button class="delete">x</button>',
            '<img></img>',
            '<label></label>',
            '</div>'
        ].join(''),

        initialize: function() {
            _.bindAll(this, 'updateBox');
            joint.dia.ElementView.prototype.initialize.apply(this, arguments);

            this.$box = $(_.template(this.template)());
            this.$box.find('.delete').on('click', _.bind(this.model.remove, this.model));
            // Update the box position whenever the underlying model changes.
            this.model.on('change', this.updateBox, this);
            // Remove the box when the model gets removed from the graph.
            this.model.on('remove', this.removeBox, this);

            this.updateBox();
        },
        render: function() {
            joint.dia.ElementView.prototype.render.apply(this, arguments);
            this.paper.$el.prepend(this.$box);
            this.updateBox();
            return this;
        },
        updateBox: function() {
            // Set the position and dimension of the box so that it covers the JointJS element.
            var bbox = this.model.getBBox();
            // Example of updating the HTML with a data stored in the cell model.
            this.$box.find('label').text(this.model.get('label'));
            this.$box.css({ width: bbox.width, height: bbox.height, left: bbox.x, top: bbox.y, transform: 'rotate(' + (this.model.get('angle') || 0) + 'deg)' });
        },
        removeBox: function(evt) {
            this.$box.remove();
        }
    });

    console.log("Done!");
  }

  function getDefaultLink(){
    var tempLink = selectedLinkTypeCell.clone();
    tempLink.label(0,{ attrs: { text: { 'font-weight': 'normal', 'font-size': 10  } } });
    return tempLink;
  }

  function makeLinksInteractive(flag){

    var links = graph.getLinks();

    if(!flag){
      $('.link-tools .tool-remove').css({"display":"none"});
      $('.link-tools .tool-options').css({"display":"none"});
    }else{
      $('.link-tools .tool-remove').css({"display":""});
      $('.link-tools .tool-options').css({"display":""});
    }

    //making links not editable
    for(var i=0; i<links.length;i++){
      var currentLink = links[i];
      var currentView = currentLink.findView(paper);
      if(!flag){
        currentView.options.interactive = false;
      }else{
        currentView.options.interactive = true;
      }
    }
  }

  function makeElementsInteractive(flag){

    var nodes = graph.getElements();

    for(var i=0; i<nodes.length;i++){
      var currentNode = nodes[i];
      var currentView = currentNode.findView(paper);
      if( !flag ){
        currentView.options.interactive = false;
        currentNode.attr("image/magnet","");
      }else{
        currentNode.attr("image/magnet","true");
        currentView.options.interactive = true;
      }
    }

  }


  function isLinkInvalid(link){
    console.log(link);
    return (!link.prop('source/id') || !link.prop('target/id'));
  }

  function rotateCellToTheRight(){
     console.log("rotateCellToTheRight");
     if(selectedCell){
       console.log(selectedCell.model);
       console.log("before",selectedCell.angle);
       selectedCell.model.rotate(rotateCellFactor);
       console.log("after",selectedCell.angle);
     }
  }

  function rotateCellToTheLeft(){
    console.log("rotateCellToTheLeft");
    if(selectedCell){
      console.log("before",selectedCell.model.angle);
      selectedCell.model.rotate(-rotateCellFactor);
      console.log("after",selectedCell.model.angle);
    }
  }

  function bringSelectedCellToFront(){
    if(selectedCell){
      selectedCell.model.toFront();
    }
  }

  function bringSelectedCellToBack(){
    if(selectedCell){
      selectedCell.model.toBack();

      currentBackgroundCell.toBack();
      backgroundBox.toBack();
    }
  }

  function updatePaperDimensionsBasedOnTextInputs(){
    //---update dimension values on text inputs
    var tempWidth = $('#inputWidth').prop('value');
    var tempHeight = $('#inputHeight').prop('value');
    paperInitialWidth = tempWidth;
    paperInitialHeight = tempHeight;
    updatePaperDimensions(tempWidth, tempHeight);
  }

  function updatePaperDimensions(tempWidth, tempHeight){
    console.log("updatePaperDimensions");
    paper.setDimensions(tempWidth,tempHeight);
    updateBackgroundBoxDimensions(tempWidth, tempHeight);
    paper.render();
  }

  function updateBackgroundBoxDimensions(widthValue, heightValue){
      backgroundBox.prop("size", {"width":widthValue,"height":heightValue});
  }

  function onStageDown(evt, x, y){
    console.log("onStageDown");

    pointerDownClientX = evt.clientX;
    pointerDownClientY = evt.clientY;

    lastPositionMouseX = pointerDownClientX;
    lastPositionMouseY = pointerDownClientY;

    if(document.getElementById("lockDiagramCheckBox").checked == true){
      paperIsPanning = true;
    }
  }

  function onStageClick(evt, x, y){

    console.log("onStageClick");

    if(document.getElementById("lockDiagramCheckBox").checked != true){
      /*var tempCell = new joint.shapes.html.Element(selectedNodeTypeCell);
      tempCell.prop("position", {"x":x,"y":y});
      tempCell.attr("label","lalalala");
      graph.addCell(tempCell);
      tempCell.toFront();*/
      cloneCellAt(selectedNodeTypeCell,x,y);
    }else{
       paperIsPanning = true;
    }

    if(readOnlyMode){
      selectNodeCell(selectedCell, false);
    }
  }

  function updatePaperDimensionsTextInputs(width, height){
    $('#inputWidth').prop('value',width);
    $('#inputHeight').prop('value',height);
  }

  function onSetBackgroundButtonClick(){
    $('#background_dialog').modal({
         show: true
     });
  }

  function setSelectedBackground(){
    $('#background_dialog').modal('hide');

    if(currentBackgroundCell){
      console.log("There already was a background for this diagram...");
      if(currentBackgroundCell.id != selectedBackgroundCell.id){
        console.log("The background selected is different from the current one");
        currentBackgroundCell.remove();
      }
    }
    console.log("let's create the new background cell!");

    var newBackgroundCell = selectedBackgroundCell.clone();
    var realSize = newBackgroundCell.prop("real_size");
    var realWidth = realSize.width;
    var realHeight = realSize.height;
    //var nodeType = newBackgroundCell.attr("node_type");
    //console.log(realWidth, realHeight, realSize, nodeType);

    newBackgroundCell.prop("size", {"width":realWidth,"height":realHeight});
    newBackgroundCell.prop("position", {"x":0,"y":0});
    newBackgroundCell.attr("image/magnet","");
    newBackgroundCell.attr("image/width", realWidth);
    newBackgroundCell.attr("image/height", realHeight);
    newBackgroundCell.attr('text/font-weight',"normal");

    graph.addCell(newBackgroundCell);
    newBackgroundCell.toBack();
    backgroundBox.toBack();
    console.log(newBackgroundCell);
    currentBackgroundCell = newBackgroundCell;
    currentBackgroundCell.findView(paper).options.interactive = false;
    paper.render();
    console.log("done!");

  }

	</script>
</body>
</html>
