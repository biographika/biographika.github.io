<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>
  Bio4j Graph Editor
</title>
<!-- Bootstrap Core CSS -->
<link href="css/bootstrap.css" rel="stylesheet" type='text/css'>
<style type="text/css">

  body {
      background-color: #f8f8f8;
  }

  .panel {
    margin-right: 10px;
  	margin-left: 10px;
  	margin-top: 10px;
  }

  #wrapper {
      width: 100%;
      height: 100$;
  }

  #page-wrapper {
      background-color: #fff;
  }

  #toolbar {
    width: 100%;
    margin-left: 10px;
    margin-right: 10px;
  }

  .nav-bar-logo{
  	margin-left: 30px;
  	height: 40px;
  }

  .nav-bar-text{
    width: 100%;
  }

 .push {
    height: 63px;
  }
  footer {
      background: #d9edf7;
      padding: 5px 0 5px 0px;
      border-top: 1px solid #4C8DAD;
  }

  .btn-file {
    position: relative;
    overflow: hidden;
  }
  .btn-file input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      background: white;
      cursor: inherit;
      display: block;
  }

  #node_types_list{
    background-color: #F0F0F0;
  }

  #graph-container{
    overflow: auto;
    max-height: 450px;
    min-height: 450px;
    border: 1px solid gray;
  }
  #node_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
  }
  #link_types_list{
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 450px;
    min-height: 200px;
  }

/*

  .html-element label {
     color: #333;
     text-shadow: 1px 0 0 lightgray;
     font-weight: bold;
   }

   .html-element button.delete:hover {
       width: 20px;
       height: 20px;
       line-height: 20px;
    }

    .html-element button.delete {
       color: white;
       border: none;
       background-color: #C0392B;
       border-radius: 20px;
       width: 15px;
       height: 15px;
       line-height: 15px;
       text-align: middle;
       position: absolute;
       top: -15px;
       left: -15px;
       padding: 0;
       margin: 0;
       font-weight: bold;
       cursor: pointer;
    }
*/
/*
    .html-element {
       position: absolute;
       background: #3498DB;
        Make sure events are propagated to the JointJS element so, e.g. dragging works.
       pointer-events: none;
       -webkit-user-select: none;
       border-radius: 4px;
       border: 2px solid #2980B9;
       box-shadow: inset 0 0 5px black, 2px 2px 1px gray;
       padding: 5px;
       box-sizing: border-box;
       z-index: 2;
    }
    .html-element select,
    .html-element input,
    .html-element button {
        Enable interacting with inputs only.
       pointer-events: auto;
    }
*/

</style>
<link rel="stylesheet" type="text/css" href="css/joint.css" />
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/joint.js"></script>
<script src="js/jquery.mousewheel.js"></script>
<script type="text/javascript"> if (!window.console) console = {log: function() {}}; </script>
<script type="text/javascript"> window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;</script>
<body onload="onBodyLoad()">
  <div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
      <div class="navbar-header">
		      <a href="index.html" target="_blank" class="pull-left nav-bar-logo"><img src="images/biographika_logo_tiny.svg"></a>
          <a class="navbar-brand"><strong>Biographika: </strong>Bio4j data graph visualization</a>
      </div>
      <!-- /.navbar-static-side -->
    </nav>
    <div id="page-wrapper">
      <div class="panel panel-info">
        <div class="panel-heading">
          <i class="fa fa-fw">
          </i>
            Graph explorer
        </div>
        <!-- /.panel-heading -->
        <div class="panel-body">
          <div class="row">
            <div id="link_types_list" class="col-xs-2">
            </div>
            <div id="graph-container" class="col-xs-8" >
            </div>
            <div class="col-xs-2">
              <div class="btn-group">
                  <button type="button" data-toggle="dropdown" class="btn btn-default dropdown-toggle">Themes <span class="caret"></span></button>
                  <ul id="themesDropDownMenu" class="dropdown-menu">
                      <li class="dropdown-header">BIOLOGY</li>
                      <li><a id="proteinsThemeButton" role="button">Proteins</a></li>
                      <li class="dropdown-header">GENERAL</li>
                      <li><a id="doPlanningThemeButton" role="button">Doplanning</a></li>
                  </ul>
              </div>
              <div id="node_types_list" />
            </div>
          </div>
        </div>
        <!-- /.panel-body -->
      </div>
      <div id="toolbar">
        <div class="btn-group btn-block" >
            <div class="btn-group">
              <button class="btn btn-default" type="button" onclick="loadSample()">Load sample</button>
              <span class="btn btn-default btn-file">
                  Load file... <input type="file" accept=".json">
              </span>
              <button type="button" class="btn btn-default dropdown-toggle"
                data-toggle="dropdown">
                Export to...
                <span class="caret"></span>
              </button>
              <ul id="exportDropDownMenu" class="dropdown-menu" >
                <li><a id="exportToJSONButton" role="button" data-toggle="modal" >JSON</a></li>
              </ul>
            </div>
            <div class="checkbox">
              <label><input id="lockDiagramCheckBox" type="checkbox" >Lock diagram</label>
            </div>
            <!-- lock diagram checkbox -->
            <div class="checkbox">
              <label><input id="deleteNodeOnClickCheckBox" type="checkbox" >Delete node on click</label>
            </div>
            <!-- delete node on click checkbox -->
            <button id="zoomInButton" onclick="zoomIn()" type="button" class="btn btn-default">Zoom in</button>
            <button id="zoomOutButton" onclick="zoomOut()" type="button" class="btn btn-default">Zoom out</button>
            <button id="resetZoomButton" onclick="resetZoom()" type="button" class="btn btn-default">Reset zoom</button>
        </div>
        <!-- button group -->
      </div>
      <!-- toolbar -->
    </div>
    <!-- page-wrapper -->
  </div>
  <div class="push"></div>
  <footer>
    <div class="container">
      <p>This example is part of <a href="http://www.biographika.com/" rel="author">Biographika</a> project.  100% of the code is open source and released under <a href="http://www.gnu.org/licenses/agpl-3.0.en.html" rel="external">AGPLv3</a> license.</p>
    </div>
  </footer>
  <script type="text/javascript">


 <!-- +++++++++++++++++++ MAIN VARS ++++++++++++++++++++++++ -->
 var graph, node_types_graph, link_types_graph, paper, node_types_paper, link_types_paper, protein_node_type, organism_node_type, genome_element_type, selected_node_type;
 // Shortcuts.
 var rect = joint.shapes.basic.Rect;
 var path = joint.shapes.basic.Path;
 var circle = joint.shapes.basic.Circle;
 var ellipse = joint.shapes.basic.Ellipse;
 var polygon = joint.shapes.basic.Polygon;
 var polyline = joint.shapes.basic.Polyline;
 var text = joint.shapes.basic.Text;
 var link = joint.dia.Link;
 joint.shapes.basic.DecoratedRect = joint.shapes.basic.Generic.extend({

    markup: '<g class="rotatable"><g class="scalable"><rect/></g><image/><text/></g>',

    defaults: joint.util.deepSupplement({

        type: 'basic.DecoratedRect',
        size: { width: 100, height: 60 },
        attrs: {
            'rect': { fill: '#FFFFFF', stroke: 'black', width: 100, height: 60},
            'text': { 'font-size': 14, text: '', 'ref-x': .5, 'ref-y': .5, ref: 'rect', 'y-alignment': 'middle', 'x-alignment': 'middle', fill: 'black'  },

        }

    }, joint.shapes.basic.Generic.prototype.defaults)
  });
 var decoratedRect = joint.shapes.basic.DecoratedRect;

 //.......paper panning related vars........
 var paperIsPanning = false;
 var pointerDownClientX;
 var pointerDownClientY;
 var lastPositionMouseX;
 var lastPositionMouseY;
 //.........................................
 //.......paper zooming related vars........
 var paperScale = 1;
 var paperScaleFactor = 0.2;
 var paperInitialWidth;
 var paperInitialHeight;
 //.........................................

 //-----node types cells------------------------
 var nodeTypeCellHeight = 100;
 var nodeTypeCellDefaultX = 15;
 var nodeTypeCellMaxWidth = 80;
 //----------------------------------------------

 //-----link types cells------------------------
 var linkTypeCellHeight = 60;
 var linkTypeCellDefaultX = 15;
 var linkTypeCellDefaultY = 30;
 var linkTypeCellMaxWidth = 120;
 //----------------------------------------------

 var selectedNodeTypeCell;
 var selectedLinkTypeCell;
 var readOnlyMode = false;

 //-----THEMES URLs------------------------
 var proteinsLinksThemeURL = "data/ProteinsLinksTheme.json";
 var proteinsElementsThemeURL = "data/ProteinsElementsTheme.json";
 var doPlanningLinksThemeURL = "data/DoPlanningLinksTheme.json";
 var doPlanningElementsThemeURL = "data/DoPlanningElementsTheme.json";
 var defaultLinksThemeURL = proteinsLinksThemeURL;
 var defaultElementsThemeURL = proteinsElementsThemeURL;
 //----------------------------------------------

 <!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->


 <!--===================DOCUMENT EVENT HANDLERS======================== -->
 $(document).mousemove(function( event ) {

   if(paperIsPanning){

     var tempClientX = event.clientX;
     var tempClientY = event.clientY;
     var differenceX = tempClientX - lastPositionMouseX;
     var differenceY = tempClientY - lastPositionMouseY;
     var currentScrollLeft = $("#graph-container").scrollLeft();
     var currentScrollTop = $("#graph-container").scrollTop();

     lastPositionMouseX += differenceX;
     lastPositionMouseY += differenceY;

     /*console.log("tempClientX: ",tempClientX,"tempClientY: ",tempClientY,"currentScrollLeft: ",
          currentScrollLeft,"currentScrollTop: ",currentScrollTop,
          "differenceX: " ,differenceX,"differenceY: " ,differenceY,
          "lastPositionMouseX: " + lastPositionMouseX,
          "lastPositionMousey: " + lastPositionMouseY);*/

     $("#graph-container").scrollLeft(currentScrollLeft + differenceX);
     $("#graph-container").scrollTop(currentScrollTop + differenceY);

     //console.log("mouse move!", pointerDownClientX, tempClientX, pointerDownClientY, tempClientY);
   }
  });
 $(document).mouseup(function( event ) {
    //console.log("mouse up!");
    paperIsPanning = false;
 });

 <!--===================================================================-->

  <!-- LOAD GRAPH BUTTON... -->
  $(document).on('change', '.btn-file :file', function() {
      var input = $(this);
      var file = input.get(0).files[0];
      var fileNameSplit = file.name.split(".");
      var fileType = fileNameSplit[fileNameSplit.length - 1];

      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
  	      var contents = e.target.result;
          //console.log(fileType);
          if(fileType != "json"){
              alert("Please select a .json file");
          }else{
             graph.fromJSON(JSON.parse(contents));

             //var bbox = graph.getBBox(graph.getElements());
             var contentBBox = paper.getContentBBox();
             paperInitialWidth = contentBBox.width + contentBBox.x;
             paperInitialHeight = contentBBox.height + contentBBox.y;

             //console.log(paperInitialWidth, paperInitialHeight);
             //console.log(contentBBox.width, contentBBox.height, contentBBox.x, contentBBox.y);

             console.log("graph loaded!");
             paper.setDimensions(paperInitialWidth,paperInitialHeight);
             paper.render();
          }
        }
        reader.readAsText(file);
      } else {
        alert("Failed to load file");
      }
  });

  <!-- LOCK DIAGRAM CHECKBOXGRAPH BUTTON... -->
  $("#lockDiagramCheckBox").click( function(){
      if( $(this).is(':checked') ){
        readOnlyMode = true;
      }else{
        readOnlyMode = false;
      }

      makeLinksInteractive(!readOnlyMode);
      makeElementsInteractive(!readOnlyMode);

      paper.render();
    }
  );


  <!-- EXPORT BUTTONS... -->
  $("#exportDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");
    if(buttonClicked == "exportToJSONButton"){
        exportToJSON();
    }

  });

  <!-- THEMES DROPDOWN... -->
  $("#themesDropDownMenu").on("click", "li", function(event){

    var buttonClicked = event.currentTarget.getElementsByTagName("a")[0].getAttribute("id");
    if(buttonClicked == "proteinsThemeButton"){
      loadLinksTheme(proteinsLinksThemeURL);
      loadNodeTypesTheme(proteinsElementsThemeURL);
    }else if(buttonClicked == "doPlanningThemeButton"){
      loadLinksTheme(doPlanningLinksThemeURL);
      loadNodeTypesTheme(doPlanningElementsThemeURL);
    }

  });

  <!-- MAKING NODE TYPES LIST ELEMENTS SELECTABLE -->
  $("ul li").click(function() {
    $(this).parent().children().removeClass("active");
    $(this).addClass("active");
  });


  function initializeJoint(){
      //initializeCustomElements();
      initializeGraphPaper();
      initializeNodeTypesPaper();
      initializeLinkTypesPaper();
  }

  function initializeGraphPaper(){
    graph = new joint.dia.Graph;
    //-----------EVENTS-----------------
    /*graph.on('all', function(eventName, cell) {
      console.log(arguments);
    });*/

    paper = new joint.dia.Paper({
      el: $('#graph-container'),
      gridSize: 1,
      model: graph,
      width: $('#graph-container').width(),
      height: $('#graph-container').height(),
      defaultLink: getDefaultLink
    });

    paper.on("blank:pointerdown",
      function(evt, x, y){
          pointerDownClientX = evt.clientX;
          pointerDownClientY = evt.clientY;

          lastPositionMouseX = pointerDownClientX;
          lastPositionMouseY = pointerDownClientY;

          //console.log(evt);

          if(document.getElementById("lockDiagramCheckBox").checked != true){
            /*var tempCell = new joint.shapes.html.Element(selectedNodeTypeCell);
            tempCell.prop("position", {"x":x,"y":y});
            tempCell.attr("label","lalalala");
            graph.addCell(tempCell);
            tempCell.toFront();*/
            cloneCellAt(selectedNodeTypeCell,x,y);
          }else{
             paperIsPanning = true;
          }
      }
    );

    paper.on("cell:mouseover",
      function(evt, x, y){
        //console.log("cell mouse over!");
      }
    );
    paper.on("cell:mouseout",
      function(evt, x, y){
        //console.log("cell mouse out!");
      }
    );
    paper.on('cell:pointerclick',
      function(cellView, evt, x, y) {

        //console.log("cell:pointerclick!");

        if(document.getElementById("deleteNodeOnClickCheckBox").checked){
          //console.log("remove!");
          cellView.remove();
        }
      }
    );
  }

  function initializeLinkTypesPaper(){
    link_types_graph = new joint.dia.Graph;
    link_types_paper = new joint.dia.Paper({
      el: $('#link_types_list'),
      gridSize: 1,
      model: link_types_graph,
      width: $('#link_types_list').width(),
      height: $('#link_types_list').height(),
      interactive: false      });

      link_types_paper.on('cell:pointerclick',
        function(linkView, evt, x, y) {
            selectLink(linkView);
        }
      );
    loadLinksTheme(defaultLinksThemeURL);
  }

  function loadLinksTheme(url){

    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          link_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfLinkTypesPaper();
          positionLinkTypesOnPaper();
          makeLinkTypesNotInteractive();
          //select first link type
          selectLink(link_types_graph.getLinks()[0].findView(link_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------


  }

  function calculateSizeOfLinkTypesPaper(){
    var numberOfTypes = link_types_graph.getLinks().length;
    link_types_paper.setDimensions(linkTypeCellMaxWidth + linkTypeCellDefaultX, linkTypeCellHeight*numberOfTypes);
    link_types_paper.render();
  }

  function positionLinkTypesOnPaper(){

    var linkTypes = link_types_graph.getLinks();

    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      var currentY = (linkTypeCellHeight * i) + linkTypeCellDefaultY;
      currentLinkType.prop("source", {"x":linkTypeCellDefaultX,"y":currentY});
      currentLinkType.prop("target", {"x":120,"y":currentY});
    }
    link_types_paper.render();
  }

  function makeLinkTypesNotInteractive(){
    var linkTypes = link_types_graph.getLinks();
    for(var i=0; i<linkTypes.length;i++){
      var currentLinkType = linkTypes[i];
      link_types_paper.findViewByModel(currentLinkType).options.interactive = false
    }
    link_types_paper.render();
  }

  function initializeNodeTypesPaper(){

    node_types_graph = new joint.dia.Graph;

    node_types_paper = new joint.dia.Paper({
      el: $('#node_types_list'),
      gridSize: 1,
      model: node_types_graph,
      width: $('#node_types_list').width(),
      height: $('#node_types_list').height(),
      interactive: false      });

      node_types_paper.on('cell:pointerclick',
        function(cellView, evt, x, y) {
            selectCell(cellView);
        }
      );
      
    loadNodeTypesTheme(defaultElementsThemeURL);
  }

  function loadNodeTypesTheme(url){
    //----loading JSON WITH THEME-----------------------
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', url, true);

    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          node_types_graph.fromJSON(JSON.parse(xobj.responseText));
          calculateSizeOfNodeTypesPaper();
          positionNodeTypesOnPaper();
          //select first node type
          selectCell(node_types_graph.getElements()[0].findView(node_types_paper));
        }
    };
    xobj.send(null);
    //------------------------------------------------
  }

  function calculateSizeOfNodeTypesPaper(){
    var numberOfTypes = node_types_graph.getElements().length;
    node_types_paper.setDimensions(100, nodeTypeCellHeight*numberOfTypes);
    node_types_paper.render();
  }

  function positionNodeTypesOnPaper(){

    var nodeTypes = node_types_graph.getElements();
    for(var i=0; i<nodeTypes.length;i++){
      var currentNodeType = nodeTypes[i];
      var currentY = nodeTypeCellHeight * i;
      currentNodeType.prop("position", {"x":nodeTypeCellDefaultX,"y":currentY});
      var currentText = currentNodeType.attr("text/text");
      var brokenText = joint.util.breakText(currentText, { width: nodeTypeCellMaxWidth });
      //console.log(currentText,brokenText);
      currentNodeType.attr("text/text", brokenText);
    }
    node_types_paper.render();
  }

  function test(){
    protein_node_type = new rect({
        position: { x: 10, y: 10 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#2ECC71', stroke: '#27AE60', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Protein' },
            name: 'Protein'
        }
    });

    organism_node_type = new rect({
        position: { x: 10, y: 60 },
        size: { width: 100, height: 40 },
        attrs: {
            rect: { rx: 2, ry: 2, fill: '#FFC72E', stroke: '#FFA42E', 'stroke-width': 2 },
            text: { 'font-size': 10, fill: '#333', text: 'Organism' },
            name: 'Organism'
        }
    });

    node_types_graph.addCell(protein_node_type);
    node_types_graph.addCell(organism_node_type);

  }

  function exportToJSON(){
    downloadJSON(JSON.stringify(graph.toJSON()));
  }

  function selectCell(cellView){

    var nodeTypeCells = node_types_graph.getElements();
    for (var i = 0; i < nodeTypeCells.length; i++) {
      var currentCell = nodeTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){
          selectedNodeTypeCell = currentCell;
          //console.log(selectedNodeTypeCell);
          currentCell.attr('text/font-weight',"bold");
      }else {
          currentCell.attr('text/font-weight',"normal");
      }
    }
  }

  function selectLink(cellView){
    console.log("selectLink!");
    var linkTypeCells = link_types_graph.getLinks();

    for (var i = 0; i < linkTypeCells.length; i++) {
      var currentCell = linkTypeCells[i];
      if(currentCell.attributes.id == cellView.model.id){
          selectedLinkTypeCell = currentCell;
          currentCell.label(0,{ attrs: { text: { 'font-weight': 'bold', 'font-size': 16 } } });
          link_types_paper.defaultLink = selectedLinkTypeCell;
          //console.log("selected",currentCell.label(0));
      }else {
        currentCell.label(0,{ attrs: { text: { 'font-weight': 'normal', 'font-size': 10  } } });
        //console.log("rest",currentCell.label(0));
      }
    }

    console.log(link_types_paper.options);
  }

  <!-- ++++++++++++++++ NODE CREATION METHODS +++++++++++ -->
  var createNodeRect = function(elm, x, y, label, widthValue, heightValue, rxValue, ryValue, fillValue, strokeValue, strokeWidthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        size: { width: widthValue, height: heightValue},
        attrs: {
          rect: { rx: rxValue, ry: ryValue, fill: fillValue, stroke: strokeValue, 'stroke-width': strokeWidthValue, magnet: true},
          text: { 'font-size': 10, fill: '#333', text: label},
          name: label

          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeEllipse = function(elm, x, y, label, widthValue) {
      var cell = new elm({
        position: { x: x, y: y },
        attrs: {
          size: { width: widthValue},
          text: { 'font-size': 10, fill: '#333', text: label , magnet: true},
          name: label,
          magnet: true
          }
      });
      graph.addCell(cell);
      return cell;
  };
  var createNodeImage = function(imgURI, x, y, widthValue, heightValue, label){
    var cell = new joint.shapes.basic.Image({
      position: { x: x, y: y },
      size: { width: widthValue, height: heightValue},
      attrs: {
        name: label,
        text: {text: label},
        magnet: true,
        image : {
            "xlink:href" : imgURI,
            width : widthValue,
            height : heightValue,
            magnet: true
          }
        }
    });
    graph.addCell(cell);
    return cell;
  }
  var createProtein = function(x, y) {
    return createNodeImage("images/protein.png", x, y, 100, 60, 'Protein');
      //return createNodeRect(rect, x, y, 'Protein', 80, 30, 2, 2, '#2ECC71', '#27AE60', 2);
  };
  var createOrganism = function(x, y) {
    return createNodeImage("images/biographika_logo_tiny.svg", x, y, 60, 60, 'Organism');
      //return createNodeEllipse(ellipse, x, y, 'Organism', 100);
  };

  function cloneCellAt(cell, x, y){
      var clonedCell = cell.clone();
      clonedCell.prop("position", {"x":x,"y":y});
      clonedCell.attr("image/magnet","true");
      graph.addCell(clonedCell);
      clonedCell.toFront();
  }


  function downloadJSON(jsonContent){

    var blob = null,
        objectUrl = null,
        dataUrl = null,
        filename = "diagram.json";


    if(window.Blob){
      // use Blob if available
      blob = new Blob([jsonContent], {type: 'text/xml'});
      objectUrl = window.URL.createObjectURL(blob);
    }
    else {
      // else use dataURI
      dataUrl = 'data:text/csv;charset=UTF-8,' + encodeURIComponent(jsonContent);
    }

    if (navigator.msSaveBlob) { // IE11+ : (has Blob, but not a[download])
      navigator.msSaveBlob(blob, filename);
    } else if (navigator.msSaveOrOpenBlob) { // IE10+ : (has Blob, but not a[download])
      navigator.msSaveOrOpenBlob(blob, filename);
    } else {
      // A-download
      var anchor = document.createElement('a');
      anchor.setAttribute('href', (window.Blob) ? objectUrl : dataUrl);
      anchor.setAttribute('download', filename || 'graph.' + extension);

      // Firefox requires the link to be added to the DOM before it can be clicked.
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
    }

    if (objectUrl) {
      setTimeout(function() { // Firefox needs a timeout
        window.URL.revokeObjectURL(objectUrl);
      }, 0);
    }

  }

  function onBodyLoad(){
    initializeJoint();
     //var tempHeight = document.getElementById("graph-container").offsetHeight;
     //var tempWidth = document.getElementById("graph-container").offsetWidth;
     //paper.setDimensions(tempWidth,tempHeight);
     //console.log(tempHeight, tempWidth);
  }

  function zoomIn(){
      paperScale = paperScale + paperScaleFactor;
      paper.scale(paperScale, paperScale);
      paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function zoomOut(){
    paperScale = paperScale - paperScaleFactor;
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }
  function resetZoom(){
    paperScale = 1;
    paper.scale(paperScale, paperScale);
    paper.setDimensions(paperInitialWidth*paperScale, paperInitialHeight*paperScale);
  }

  function initializeCustomElements(){
    console.log("Initializing custom elements...");
    // Create a custom element.
    // ------------------------

    joint.shapes.html = {};
    joint.shapes.html.Element = joint.shapes.basic.Rect.extend({
        defaults: joint.util.deepSupplement({
            type: 'html.Element',
            attrs: {
                rect: { stroke: 'none', 'fill-opacity': 0 }
            }
        }, joint.shapes.basic.Rect.prototype.defaults)
    });

    // Create a custom view for that element that displays an HTML div above it.
    // -------------------------------------------------------------------------

    joint.shapes.html.ElementView = joint.dia.ElementView.extend({

        template: [
            '<div class="html-element">',
            '<button class="delete">x</button>',
            '<img></img>',
            '<label></label>',
            '</div>'
        ].join(''),

        initialize: function() {
            _.bindAll(this, 'updateBox');
            joint.dia.ElementView.prototype.initialize.apply(this, arguments);

            this.$box = $(_.template(this.template)());
            this.$box.find('.delete').on('click', _.bind(this.model.remove, this.model));
            // Update the box position whenever the underlying model changes.
            this.model.on('change', this.updateBox, this);
            // Remove the box when the model gets removed from the graph.
            this.model.on('remove', this.removeBox, this);

            this.updateBox();
        },
        render: function() {
            joint.dia.ElementView.prototype.render.apply(this, arguments);
            this.paper.$el.prepend(this.$box);
            this.updateBox();
            return this;
        },
        updateBox: function() {
            // Set the position and dimension of the box so that it covers the JointJS element.
            var bbox = this.model.getBBox();
            // Example of updating the HTML with a data stored in the cell model.
            this.$box.find('label').text(this.model.get('label'));
            this.$box.css({ width: bbox.width, height: bbox.height, left: bbox.x, top: bbox.y, transform: 'rotate(' + (this.model.get('angle') || 0) + 'deg)' });
        },
        removeBox: function(evt) {
            this.$box.remove();
        }
    });

    console.log("Done!");
  }

  function getDefaultLink(){
    return selectedLinkTypeCell.clone();
  }

  function makeLinksInteractive(flag){

    var links = graph.getLinks();

    if(!flag){
      $('.link-tools .tool-remove').css({"display":"none"});
      $('.link-tools .tool-options').css({"display":"none"});
    }else{
      $('.link-tools .tool-remove').css({"display":""});
      $('.link-tools .tool-options').css({"display":""});
    }

    //making links not editable
    for(var i=0; i<links.length;i++){
      var currentLink = links[i];
      var currentView = currentLink.findView(paper);
      if(!flag){
        currentView.options.interactive = false;
      }else{
        currentView.options.interactive = true;
      }
    }
  }

  function makeElementsInteractive(flag){

    var nodes = graph.getElements();

    for(var i=0; i<nodes.length;i++){
      var currentNode = nodes[i];
      var currentView = currentNode.findView(paper);
      if( !flag ){
        currentView.options.interactive = false;
        currentNode.attr("image/magnet","");
      }else{
        currentNode.attr("image/magnet","true");
        currentView.options.interactive = true;
      }
    }

  }


	</script>
</body>
</html>
